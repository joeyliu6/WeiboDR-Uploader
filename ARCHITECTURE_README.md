# å¤šå›¾åºŠæ¶æ„ - æ¶æ„è¯´æ˜

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®å·²å®Œæˆå¤šå›¾åºŠæ¶æ„é‡æ„ï¼Œä»å¾®åšä¸“ç”¨å·¥å…·å‡çº§ä¸ºæ”¯æŒå¤šå›¾åºŠæœåŠ¡çš„é€šç”¨å¹³å°ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚ (main.ts)                   â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ‹–æ‹½ä¸Šä¼     â”‚  â”‚  æ–‡ä»¶é€‰æ‹©    â”‚  â”‚  å‰ªè´´æ¿ä¸Šä¼    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ ¸å¿ƒè°ƒåº¦å±‚ (UploadOrchestrator)            â”‚
â”‚                                                         â”‚
â”‚  1. é€‰æ‹©ä¸»åŠ›ä¸Šä¼ å™¨                                      â”‚
â”‚  2. éªŒè¯é…ç½®                                            â”‚
â”‚  3. æ‰§è¡Œä¸»åŠ›ä¸Šä¼                                         â”‚
â”‚  4. ç”Ÿæˆé“¾æ¥ï¼ˆLinkGeneratorï¼‰                          â”‚
â”‚  5. å¤‡ä»½ä¸Šä¼ ï¼ˆéé˜»å¡ï¼‰                                  â”‚
â”‚  6. ä¿å­˜å†å²è®°å½•                                        â”‚
â”‚  7. å‰ªè´´æ¿ + é€šçŸ¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Weibo    â”‚ â”‚    R2     â”‚ â”‚   Nami    â”‚
â”‚ Uploader  â”‚ â”‚ Uploader  â”‚ â”‚ Uploader  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ validate  â”‚ â”‚ validate  â”‚ â”‚ validate  â”‚
â”‚ upload    â”‚ â”‚ upload    â”‚ â”‚ upload    â”‚
â”‚ getUrl    â”‚ â”‚ getUrl    â”‚ â”‚ getUrl    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust Backend  â”‚       â”‚  AWS SDK     â”‚
â”‚ upload_file_  â”‚       â”‚  (S3 Client) â”‚
â”‚ stream        â”‚       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ uploaders/                    # å›¾åºŠæ¨¡å—ï¼ˆæ’ä»¶åŒ–ï¼‰
â”‚   â”œâ”€â”€ base/                     # åŸºç¡€æŠ½è±¡
â”‚   â”‚   â”œâ”€â”€ IUploader.ts          # æ ¸å¿ƒæ¥å£
â”‚   â”‚   â”œâ”€â”€ BaseUploader.ts       # æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ UploaderFactory.ts    # å·¥å‚æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ types.ts              # å…±äº«ç±»å‹
â”‚   â”‚   â””â”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ weibo/                    # å¾®åšä¸Šä¼ å™¨
â”‚   â”‚   â”œâ”€â”€ WeiboUploader.ts      # å®ç°
â”‚   â”‚   â”œâ”€â”€ WeiboError.ts         # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ r2/                       # R2 ä¸Šä¼ å™¨
â”‚   â”‚   â”œâ”€â”€ R2Uploader.ts         # å®ç°
â”‚   â”‚   â”œâ”€â”€ R2Error.ts            # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ template/                 # æ¨¡æ¿ï¼ˆä¾›å‚è€ƒï¼‰
â”‚   â”‚   â””â”€â”€ TemplateUploader.ts
â”‚   â””â”€â”€ index.ts                  # æ³¨å†Œæ‰€æœ‰ä¸Šä¼ å™¨
â”œâ”€â”€ core/                         # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ UploadOrchestrator.ts     # ä¸Šä¼ è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ LinkGenerator.ts          # é“¾æ¥ç”Ÿæˆ
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ config/                       # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ types.ts                  # é…ç½®ç±»å‹å®šä¹‰
â”œâ”€â”€ store.ts                      # åŠ å¯†å­˜å‚¨
â”œâ”€â”€ main.ts                       # åº”ç”¨å…¥å£
â””â”€â”€ integration-example.ts        # é›†æˆç¤ºä¾‹
```

---

## ğŸ”Œ æ ¸å¿ƒæ¦‚å¿µ

### 1. IUploader æ¥å£

æ‰€æœ‰å›¾åºŠä¸Šä¼ å™¨å¿…é¡»å®ç°æ­¤æ¥å£ï¼š

```typescript
interface IUploader {
  readonly serviceId: string;       // 'weibo' | 'r2' | 'nami' ...
  readonly serviceName: string;     // 'æ–°æµªå¾®åš' | 'Cloudflare R2' ...

  validateConfig(config: any): Promise<ValidationResult>;
  upload(filePath: string, options: UploadOptions, onProgress?: ProgressCallback): Promise<UploadResult>;
  getPublicUrl(result: UploadResult): string;
  testConnection?(): Promise<ConnectionTestResult>;
}
```

### 2. BaseUploader åŸºç±»

æä¾›å…±äº«é€»è¾‘ï¼š
- Rust å‘½ä»¤è°ƒç”¨
- è¿›åº¦äº‹ä»¶ç›‘å¬
- é”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•

å­ç±»åªéœ€å®ç°ï¼š
- `getRustCommand()` - è¿”å› Rust å‘½ä»¤å
- `validateConfig()` - éªŒè¯é…ç½®
- `upload()` - ä¸Šä¼ é€»è¾‘
- `getPublicUrl()` - URL ç”Ÿæˆ

### 3. UploaderFactory å·¥å‚

ç®¡ç†æ‰€æœ‰ä¸Šä¼ å™¨ï¼š

```typescript
// æ³¨å†Œ
UploaderFactory.register('weibo', () => new WeiboUploader());
UploaderFactory.register('r2', () => new R2Uploader());

// åˆ›å»º
const uploader = UploaderFactory.create('weibo');
```

### 4. UploadOrchestrator è°ƒåº¦å™¨

ç»Ÿä¸€çš„ä¸Šä¼ æµç¨‹ï¼š

```typescript
const orchestrator = new UploadOrchestrator();

const historyItem = await orchestrator.uploadFile(
  filePath,
  config,
  onProgress
);
```

è‡ªåŠ¨å¤„ç†ï¼š
- âœ… é…ç½®éªŒè¯
- âœ… ä¸»åŠ›ä¸Šä¼ 
- âœ… é“¾æ¥ç”Ÿæˆ
- âœ… å¤‡ä»½ä¸Šä¼ ï¼ˆå¼‚æ­¥ï¼‰
- âœ… å†å²è®°å½•
- âœ… å‰ªè´´æ¿
- âœ… ç³»ç»Ÿé€šçŸ¥

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. æ’ä»¶åŒ–æ¶æ„
- æ¯ä¸ªå›¾åºŠç‹¬ç«‹æ¨¡å—
- æ˜“äºæ·»åŠ æ–°å›¾åºŠ
- äº’ä¸å½±å“

### 2. ç»Ÿä¸€æ¥å£
- æ‰€æœ‰å›¾åºŠå®ç°ç›¸åŒæ¥å£
- è°ƒç”¨æ–¹å¼ä¸€è‡´
- æ˜“äºæµ‹è¯•

### 3. è´£ä»»åˆ†ç¦»
- **Uploader**: åªè´Ÿè´£ä¸Šä¼ 
- **Orchestrator**: åªè´Ÿè´£è°ƒåº¦
- **LinkGenerator**: åªè´Ÿè´£é“¾æ¥ç”Ÿæˆ
- **Store**: åªè´Ÿè´£å­˜å‚¨

### 4. éé˜»å¡å¤‡ä»½
- ä¸»åŠ›ä¸Šä¼ å®Œæˆå³å¯ä½¿ç”¨
- å¤‡ä»½å¼‚æ­¥æ‰§è¡Œ
- ä¸å½±å“ç”¨æˆ·ä½“éªŒ

### 5. æ˜“äºæ‰©å±•
- å¤åˆ¶æ¨¡æ¿å³å¯æ·»åŠ æ–°å›¾åºŠ
- Rust + TypeScript åŒç«¯æ‰©å±•
- é…ç½®ç±»å‹è‡ªåŠ¨æç¤º

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åˆå§‹åŒ–ä¸Šä¼ å™¨

```typescript
import { initializeUploaders } from './uploaders';

// åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡
initializeUploaders();
```

### ä¸Šä¼ æ–‡ä»¶

```typescript
import { UploadOrchestrator } from './core';

const orchestrator = new UploadOrchestrator();

const config = {
  primaryService: 'weibo',
  services: {
    weibo: { enabled: true, cookie: '...' }
  },
  outputFormat: 'baidu-proxy',
  baiduPrefix: 'https://image.baidu.com/search/down?thumburl='
};

const result = await orchestrator.uploadFile(
  '/path/to/image.jpg',
  config,
  (percent) => console.log(`è¿›åº¦: ${percent}%`)
);

console.log('ä¸Šä¼ æˆåŠŸ:', result.generatedLink);
```

### æ·»åŠ æ–°å›¾åºŠ

1. å¤åˆ¶ `template/TemplateUploader.ts`
2. å®ç° Rust å‘½ä»¤
3. æ³¨å†Œåˆ° `uploaders/index.ts`
4. æ·»åŠ é…ç½®ç±»å‹
5. æ›´æ–° UI

è¯¦ç»†æ­¥éª¤å‚è§ [REFACTORING_GUIDE.md](REFACTORING_GUIDE.md)

---

## ğŸ“Š å·²å®ç°åŠŸèƒ½

### âœ… Phase 1-3: åŸºç¡€æ¶æ„
- [x] ç›®å½•ç»“æ„
- [x] æ ¸å¿ƒæ¥å£ï¼ˆIUploader, BaseUploader, UploaderFactoryï¼‰
- [x] WeiboUploaderï¼ˆé‡æ„è‡ª weiboUploader.tsï¼‰
- [x] R2Uploaderï¼ˆé‡æ„è‡ª coreLogic.tsï¼‰
- [x] æ–°é…ç½®ç±»å‹ï¼ˆUserConfig, HistoryItemï¼‰

### âœ… Phase 4: æ ¸å¿ƒé€»è¾‘
- [x] LinkGeneratorï¼ˆç™¾åº¦å‰ç¼€å¤„ç†ï¼‰
- [x] UploadOrchestratorï¼ˆä¸Šä¼ è°ƒåº¦ï¼‰
- [x] Rust å‘½ä»¤æ¡†æ¶ï¼ˆupload_to_r2 å·²æ³¨å†Œï¼‰

### âœ… å·¥å…·å’Œæ–‡æ¡£
- [x] é›†æˆç¤ºä¾‹ï¼ˆintegration-example.tsï¼‰
- [x] æ¨¡æ¿ä¸Šä¼ å™¨ï¼ˆTemplateUploader.tsï¼‰
- [x] è¿ç§»æŒ‡å—ï¼ˆREFACTORING_GUIDE.mdï¼‰
- [x] æ¶æ„è¯´æ˜ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### éœ€è¦å®Œæˆçš„å·¥ä½œ

1. **Rust R2 å®ç°**
   - åœ¨ `Cargo.toml` ä¸­æ·»åŠ  AWS SDK ä¾èµ–
   - å®Œå–„ `src-tauri/src/commands/r2.rs` ä¸­çš„ TODO éƒ¨åˆ†

2. **main.ts é›†æˆ**
   - è°ƒç”¨ `initializeUploaders()`
   - æ›¿æ¢ `handleFileUpload` ä¸º `UploadOrchestrator`
   - å‚è€ƒ `integration-example.ts`

3. **UI æ›´æ–°**
   - è®¾ç½®é¡µé¢ï¼šä¸»åŠ›å›¾åºŠé€‰æ‹©å™¨
   - å†å²è®°å½•ï¼šæœåŠ¡æ ‡è¯†æ˜¾ç¤º
   - ç™»å½•çª—å£ï¼šæ”¯æŒå¤šå›¾åºŠ

4. **æµ‹è¯•**
   - å¾®åšä¸Šä¼ æµ‹è¯•
   - R2 ä¸Šä¼ æµ‹è¯•
   - å¤‡ä»½åŠŸèƒ½æµ‹è¯•

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **å‰ç«¯**: TypeScript, Vue 3, Tauri API
- **åç«¯**: Rust, reqwest, AWS SDK
- **å­˜å‚¨**: AES-GCM åŠ å¯†å­˜å‚¨
- **é€šä¿¡**: Tauri IPC, Event System

---

## ğŸ“ æ”¯æŒ

- **è¿ç§»æŒ‡å—**: [REFACTORING_GUIDE.md](REFACTORING_GUIDE.md)
- **é›†æˆç¤ºä¾‹**: [integration-example.ts](src/integration-example.ts)
- **æ¨¡æ¿å‚è€ƒ**: [TemplateUploader.ts](src/uploaders/template/TemplateUploader.ts)
- **è¯¦ç»†è®¡åˆ’**: `.claude/plans/elegant-fluttering-llama.md`

---

## ğŸ“ è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ä¿æŒä¸€è‡´
