<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/src/style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeiboDR-Uploader (微博灾备上传器)</title>
  </head>
  <body>
    <div id="titlebar" data-tauri-drag-region>
      <div class="titlebar-drag-region" data-tauri-drag-region>
        <span class="app-title">WeiboDR</span>
      </div>
      <div class="titlebar-controls">
        <div class="titlebar-button" id="titlebar-minimize">
          <img src="https://api.iconify.design/mdi:window-minimize.svg" alt="minimize" />
        </div>
        <div class="titlebar-button" id="titlebar-maximize">
          <img src="https://api.iconify.design/mdi:window-maximize.svg" alt="maximize" />
        </div>
        <div class="titlebar-button close" id="titlebar-close">
          <img src="https://api.iconify.design/mdi:close.svg" alt="close" />
        </div>
      </div>
    </div>
    <div class="dashboard-container">
      <div class="sidebar">
        <button id="nav-upload" class="nav-btn active" title="上传">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span class="nav-text">上传</span>
        </button>
        <button id="nav-history" class="nav-btn" title="历史记录">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span class="nav-text">历史</span>
        </button>
        <button id="nav-failed" class="nav-btn" title="失败列表">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          <span class="nav-text">失败</span>
          <span class="badge" id="badge" style="display: none;">0</span>
        </button>
        <button id="nav-r2-manager" class="nav-btn" title="R2 管理">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
          <span class="nav-text">R2 管理</span>
        </button>
        <button id="nav-settings" class="nav-btn" title="设置">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          <span class="nav-text">设置</span>
        </button>
      </div>
      <div class="content-area">
        <div id="upload-view" class="view active">
          <div class="upload-container">
            <!-- 顶部拖拽区域 -->
            <div id="drop-zone-header">
              <div id="drop-message">
                <p>
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: block; margin: 0 auto 10px auto;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  拖拽图片到此处上传
                </p>
                <span>或点击选择文件</span>
              </div>
              <input type="file" id="file-input" multiple accept="image/*" style="display: none;" />
            </div>
            
            <!-- R2 备份开关 -->
            <div class="upload-controls">
              <label class="r2-toggle">
                <input type="checkbox" id="upload-view-toggle-r2" checked />
                <span>同时备份到 Cloudflare R2</span>
              </label>
            </div>
            
            <!-- 上传队列列表 -->
            <div id="upload-queue-container">
              <h3>上传队列</h3>
              <div id="upload-queue-list"></div>
            </div>
          </div>
        </div>
        <div id="history-view" class="view">
          <div class="container">
            <h1>上传历史记录</h1>
            
            <!-- v-1.2 新增：搜索框 -->
            <div class="search-section">
                <input type="text" id="search-input" placeholder="搜索本地文件名..." />
            </div>
            
            <table id="history-table">
                <thead>
                    <tr>
                        <th>预览</th>
                        <th>本地文件名</th>
                        <th>生成链接</th>
                        <th>上传时间</th>
                        <th>复制</th>
                        <th>删除</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                </tbody>
            </table>
    
            <div class="footer">
                <button id="export-json-btn">导出为 JSON</button>
                <button id="sync-webdav-btn">立即同步到 WebDAV</button>
                <button id="clear-history-btn">清空历史</button>
                <span id="status-message"></span>
            </div>
        </div>
        </div>
        <div id="settings-view" class="view">
          <div class="container">
            <h1>设置</h1>
    
            <div class="form-section">
                <h2>微博 Cookie (必填)</h2>
                <p>用于 m.weibo.cn 接口。这是项目成功的关键。</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="login-with-webview-btn" style="flex: 1; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        自动获取Cookie
                    </button>
                    <button id="test-cookie-btn" style="flex: 1;">测试连接</button>
                </div>
                <textarea id="weibo-cookie" rows="5" placeholder="在此粘贴从 m.weibo.cn 获取的完整 Cookie 字符串...或点击上方'自动获取Cookie'按钮"></textarea>
                <span id="cookie-status"></span>
            </div>
    
            <div class="form-section">
                <h2>Cloudflare R2 备份 (可选)</h2>
                <p>步骤 A 成功后，将图片异步备份到 R2。</p>
                <label>R2 账户 ID (Account ID)</label>
                <input type="text" id="r2-account-id" />
    
                <label>R2 访问密钥 ID (Access Key ID)</label>
                <input type="password" id="r2-key-id" />
    
                <label>R2 访问密钥 (Secret Access Key)</label>
                <input type="password" id="r2-secret-key" />
    
                <label>R2 存储桶名称 (Bucket Name)</label>
                <input type="text" id="r2-bucket" />
    
                <label>R2 自定义路径 (Optional Path)</label>
                <input type="text" id="r2-path" placeholder="例如: blog/images/ (留空则为根目录)" />
    
                <label>R2 公开访问域名 (Public Domain)</label>
                <input type="text" id="r2-public-domain" placeholder="例如: https://images.example.com (末尾不要加 /)" />
                
                <button type="button" id="test-r2-btn">测试 R2 连接</button>
                <span id="r2-status-message"></span>
            </div>
    
            <div class="form-section">
                <h2>输出格式 (PRD 3.2)</h2>
                <label>百度代理前缀</label>
                <input type="text" id="baidu-prefix" value="https://image.baidu.com/search/down?thumburl=" />
                
                <label>链接格式选项</label>
                <div class="radio-group">
                    <input type="radio" id="format-baidu" name="output-format" value="baidu" checked>
                    <label for="format-baidu">百度代理链接 (用于发布)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="format-weibo" name="output-format" value="weibo">
                    <label for="format-weibo">large 微博原始链接 (用于调试)</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="format-r2" name="output-format" value="r2">
                    <label for="format-r2">R2 公开访问链接 (用于切换灾备)</label>
                </div>
            </div>
    
            <div class="form-section">
                <h2>WebDAV 自动备份 (可选) (v1.2)</h2>
                <p>配置后，每次上传成功会自动将历史记录同步到 WebDAV（例如：坚果云）。</p>
                <label>WebDAV URL</label>
                <input type="text" id="webdav-url" placeholder="例如: https://dav.jianguoyun.com/dav/" />
                
                <label>WebDAV 用户名</label>
                <input type="text" id="webdav-username" placeholder="通常是邮箱" />
                
                <label>WebDAV 密码</label>
                <input type="password" id="webdav-password" placeholder="通常是应用的授权码" />
                
            <label>远程路径 <span style="color: #888; font-size: 0.9em;">(将覆盖同名文件)</span></label>
            <input type="text" id="webdav-remote-path" placeholder="例如: /WeiboDR/history.json 或 /WeiboDR/" value="/WeiboDR/history.json" />
            <p style="font-size: 0.85em; color: #888; margin-top: 5px;">
                💡 提示：支持完整路径（如 /path/history.json）或目录（如 /path/，自动存为 history.json）。同步将覆盖旧文件。
            </p>
                
                <button type="button" id="test-webdav-btn">测试 WebDAV 连接</button>
                <span id="webdav-status-message"></span>
            </div>
    
            <div class="footer">
                <span id="save-status"></span>
            </div>
        </div>
        </div>
        <div id="failed-view" class="view">
          <div class="container">
            <h1>失败队列</h1>
            
            <div class="footer" style="margin-bottom: 20px;">
                <button id="retry-all-btn">全部重试</button>
                <button id="clear-all-failed-btn">全部清除</button>
            </div>
            
            <table id="failed-table">
                <thead>
                    <tr>
                        <th>本地文件名</th>
                        <th>失败原因</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="failed-body">
                </tbody>
            </table>
        </div>
        </div>
        <div id="r2-manager-view" class="view">
          <div class="r2-manager-container">
            <div class="r2-manager-toolbar">
              <div class="r2-toolbar-title">
                <svg class="r2-toolbar-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                <span class="r2-toolbar-title-text">R2 存储管理</span>
              </div>
              <div class="r2-toolbar-controls">
                <label class="r2-select-all">
                  <input type="checkbox" id="r2-select-all" />
                  <span>全选</span>
                </label>
                <button id="r2-batch-delete-btn" class="r2-btn r2-btn-danger r2-btn-compact">
                  <span class="r2-btn-text">删除</span>
                  <span id="r2-batch-count" class="r2-btn-badge">(0)</span>
                </button>
                <div class="r2-toolbar-info">
                  <span id="r2-bucket-info" class="r2-info-text"></span>
                  <span id="r2-stats-info" class="r2-stats-text"></span>
                </div>
                <button id="r2-refresh-btn" class="r2-btn r2-btn-icon-text">
                  <svg class="r2-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                  <span class="r2-btn-text">刷新</span>
                </button>
              </div>
            </div>
            <div id="r2-loading" class="r2-loading" style="display: none;">
              <div class="r2-spinner"></div>
              <p>加载中...</p>
            </div>
            <div id="r2-error-message" class="r2-error-message" style="display: none;"></div>
            <div id="r2-grid-container" class="r2-grid"></div>
          </div>
          <!-- 预览模态框 -->
          <div id="r2-modal" class="r2-modal" style="display: none;">
            <div class="r2-modal-overlay"></div>
            <div class="r2-modal-content">
              <button class="r2-modal-close" id="r2-modal-close-btn">✕</button>
              <img id="r2-modal-image" class="r2-modal-image" alt="预览图片" />
              <div class="r2-modal-footer">
                <div class="r2-modal-info">
                  <p id="r2-modal-filename"></p>
                  <p id="r2-modal-filesize"></p>
                </div>
                <div class="r2-modal-actions">
                  <button id="r2-modal-copy-btn" class="r2-btn r2-btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    复制链接
                  </button>
                  <button id="r2-modal-delete-btn" class="r2-btn r2-btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: text-bottom; margin-right: 4px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    删除
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Generic Confirmation Modal -->
    <div id="confirm-modal" class="modal" style="display: none;">
      <div class="modal-overlay"></div>
      <div class="modal-content confirm-modal-content">
        <div class="modal-header">
          <h3 id="confirm-modal-title">确认</h3>
          <button class="modal-close" id="confirm-modal-close">✕</button>
        </div>
        <div class="modal-body">
          <p id="confirm-modal-message"></p>
        </div>
        <div class="modal-footer">
          <button id="confirm-modal-cancel" class="btn btn-secondary">取消</button>
          <button id="confirm-modal-ok" class="btn btn-danger">确定</button>
        </div>
      </div>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>

