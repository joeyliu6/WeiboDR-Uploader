# WebDAV 自动备份配置指南

## 📋 配置项说明

WebDAV 自动备份功能需要填写以下 4 个配置项：

### 1. **WebDAV URL**（必填）
- **说明**：WebDAV 服务器的地址
- **格式**：完整的 HTTPS URL，通常以 `/dav/` 或 `/` 结尾
- **示例**：
  - 坚果云：`https://dav.jianguoyun.com/dav/`
  - Nextcloud：`https://your-domain.com/remote.php/dav/files/username/`
  - 其他服务：请参考对应服务的 WebDAV 文档

### 2. **WebDAV 用户名**（必填）
- **说明**：用于认证的用户名
- **格式**：通常是邮箱地址或用户名
- **示例**：
  - 坚果云：`your-email@example.com`
  - Nextcloud：`your-username`

### 3. **WebDAV 密码**（必填）
- **说明**：用于认证的密码
- **⚠️ 重要**：**不是登录密码**，而是**应用授权码**或**应用专用密码**
- **示例**：
  - 坚果云：应用授权码（格式类似：`abcd-efgh-ijkl-mnop`）
  - Nextcloud：应用密码或账户密码

### 4. **远程路径**（必填）
- **说明**：在 WebDAV 服务器上保存历史记录文件的路径
- **格式**：以 `/` 开头的绝对路径，包含文件名
- **默认值**：`/WeiboDR/history.json`
- **示例**：
  - `/WeiboDR/history.json`（推荐）
  - `/backup/weibo-history.json`
  - `/Documents/WeiboDR/history.json`

---

## 🔧 常见服务配置示例

### 坚果云（推荐）

1. **获取应用授权码**：
   - 登录 [坚果云网页版](https://www.jianguoyun.com/)
   - 进入"账户信息" → "安全选项"
   - 点击"添加应用密码"
   - 输入应用名称（如：`WeiboDR-Uploader`）
   - 记录生成的授权码（格式：`xxxx-xxxx-xxxx-xxxx`）

2. **填写配置**：
   ```
   WebDAV URL: https://dav.jianguoyun.com/dav/
   用户名: your-email@example.com
   密码: xxxx-xxxx-xxxx-xxxx  (应用授权码)
   远程路径: /WeiboDR/history.json
   ```

3. **测试连接**：
   - 点击"测试 WebDAV 连接"按钮
   - 看到绿色"✓ WebDAV 连接成功！"即表示配置正确

---

### Nextcloud

1. **获取应用密码**（可选，更安全）：
   - 登录 Nextcloud
   - 进入"设置" → "安全" → "设备与会话"
   - 创建应用密码

2. **填写配置**：
   ```
   WebDAV URL: https://your-domain.com/remote.php/dav/files/username/
   用户名: your-username
   密码: your-password 或 应用密码
   远程路径: /WeiboDR/history.json
   ```

---

### 其他 WebDAV 服务

对于其他支持 WebDAV 的服务（如 iCloud、OneDrive、Dropbox 等），请：
1. 查阅服务商的 WebDAV 配置文档
2. 获取正确的 WebDAV URL
3. 获取应用授权码或专用密码
4. 按照上述格式填写配置

---

## ✅ 配置步骤

### 快速配置流程

1. **打开设置页面**
   - 点击导航栏的"设置"按钮

2. **填写 WebDAV 配置**
   - 在"WebDAV 自动备份"区域填写 4 个配置项
   - 配置会自动保存（无需点击保存按钮）

3. **测试连接**
   - 点击"测试 WebDAV 连接"按钮
   - 等待测试结果（通常 1-3 秒）

4. **验证结果**
   - ✅ **成功**：显示绿色"✓ WebDAV 连接成功！"
   - ❌ **失败**：显示红色错误信息，根据提示检查配置

5. **完成**
   - 配置成功后，每次上传图片时，历史记录会自动同步到 WebDAV

---

## ❓ 常见问题

### Q1: 为什么测试连接失败？

**可能原因及解决方法：**

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| "配置不完整" | 必填字段为空 | 确保填写所有 4 个配置项 |
| "用户名或密码错误" | 认证失败 | 检查用户名和密码，确认使用的是**应用授权码**而不是登录密码 |
| "URL 未找到" | URL 错误 | 检查 WebDAV URL 是否正确，注意末尾的 `/` |
| "无法连接到服务器" | 网络问题 | 检查网络连接和防火墙设置 |
| "HTTP 409" | 文件冲突 | 已修复，现在会自动覆盖现有文件 |

### Q2: WebDAV 密码是什么？

**A:** WebDAV 密码通常是**应用授权码**或**应用专用密码**，**不是您的登录密码**。

- **坚果云**：需要在"安全选项"中生成应用授权码
- **Nextcloud**：可以使用账户密码或创建应用密码
- **其他服务**：请查阅服务商的文档

### Q3: 远程路径应该怎么写？

**A:** 远程路径是文件在 WebDAV 服务器上的保存位置。

- **格式**：以 `/` 开头的绝对路径
- **示例**：`/WeiboDR/history.json`
- **说明**：
  - `/WeiboDR/` 是文件夹路径（如果不存在会自动创建）
  - `history.json` 是文件名
  - 文件会保存为 JSON 格式，包含所有上传历史记录

### Q4: 配置后如何验证自动备份是否工作？

**A:** 
1. 配置完成后，上传一张图片
2. 等待上传成功
3. 登录您的 WebDAV 服务（如坚果云网页版）
4. 检查远程路径指定的文件是否存在
5. 打开文件，应该能看到包含上传记录的 JSON 数据

### Q5: 自动备份会影响上传速度吗？

**A:** 不会。自动备份是**异步非阻塞**的：
- 上传成功后立即返回结果
- 备份在后台进行
- 即使备份失败，也不会影响上传功能

### Q6: 可以手动触发同步吗？

**A:** 可以。在"历史记录"页面有一个"同步到 WebDAV"按钮，可以手动触发同步。

---

## 🔒 安全提示

1. **不要分享应用授权码**：应用授权码具有完整的账户访问权限
2. **定期更换授权码**：如果怀疑授权码泄露，及时在服务商处删除并重新生成
3. **使用 HTTPS**：确保 WebDAV URL 使用 `https://` 协议
4. **本地存储**：所有配置信息都保存在本地，不会上传到第三方服务器

---

## 📝 配置示例总结

### 坚果云完整示例

```
WebDAV URL: https://dav.jianguoyun.com/dav/
用户名: user@example.com
密码: abcd-efgh-ijkl-mnop
远程路径: /WeiboDR/history.json
```

### 测试步骤

1. 填写上述配置
2. 点击"测试 WebDAV 连接"
3. 看到"✓ WebDAV 连接成功！"即完成
4. 配置会自动保存，无需额外操作

---

## 🎯 功能说明

配置 WebDAV 自动备份后：

- ✅ **自动同步**：每次上传成功，历史记录会自动同步到 WebDAV
- ✅ **非阻塞**：备份失败不会影响上传功能
- ✅ **覆盖更新**：如果文件已存在，会自动覆盖（已修复 HTTP 409 错误）
- ✅ **JSON 格式**：历史记录以 JSON 格式保存，便于查看和恢复

---

**需要帮助？** 如果遇到问题，请：
1. 查看本指南的"常见问题"部分
2. 检查 `SETTINGS_V2_USER_GUIDE.md` 了解其他设置
3. 在 GitHub Issues 中提交问题

