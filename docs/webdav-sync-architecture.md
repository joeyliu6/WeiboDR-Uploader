# WebDAV å¤‡ä»½ä¸åŒæ­¥åŠŸèƒ½ - å¼€å‘æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv2.10
> æœ€åæ›´æ–°ï¼š2025-01-27
> ç»´æŠ¤è€…ï¼šPicNexus Team

---

## ä¸€ã€æ¨¡å—æ¦‚è¿°

WebDAV åŒæ­¥æ¨¡å—æä¾›ç”¨æˆ·é…ç½®å’Œä¸Šä¼ å†å²è®°å½•çš„äº‘ç«¯å¤‡ä»½ä¸å¤šè®¾å¤‡åŒæ­¥åŠŸèƒ½ã€‚æ”¯æŒä¸»æµ WebDAV æœåŠ¡ï¼ˆåšæœäº‘ã€ç¾¤æ™– NASã€Nextcloud ç­‰ï¼‰ã€‚

### 1.1 æ ¸å¿ƒèƒ½åŠ›

| åŠŸèƒ½ | æè¿° |
|------|------|
| é…ç½®åŒæ­¥ | ç”¨æˆ·è®¾ç½®ï¼ˆå›¾åºŠé…ç½®ã€ä¸»é¢˜ç­‰ï¼‰çš„äº‘ç«¯å¤‡ä»½ |
| å†å²è®°å½•åŒæ­¥ | ä¸Šä¼ è®°å½•çš„è·¨è®¾å¤‡åŒæ­¥ |
| å¤šé…ç½®ç®¡ç† | æ”¯æŒå¤šä¸ª WebDAV é…ç½®åˆ‡æ¢ |
| è‡ªåŠ¨åŒæ­¥ | å®šæ—¶è‡ªåŠ¨ä¸Šä¼ ï¼ˆå¯é…ç½®é—´éš”ï¼‰ |
| å†²çªå¤„ç† | è¦†ç›–/åˆå¹¶ä¸¤ç§ç­–ç•¥ |

### 1.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              UI Layer                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   SettingsView.vue  â”‚  â”‚ SyncConflictDialog  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
              â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Composable Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   useWebDAVSync     â”‚â—„â”€â”¤    useAutoSync      â”‚                       â”‚
â”‚  â”‚   (æ ¸å¿ƒåŒæ­¥é€»è¾‘)     â”‚  â”‚   (å®šæ—¶è°ƒåº¦å™¨)       â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Service Layer                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   WebDAVClient      â”‚  â”‚   HistoryDatabase   â”‚                       â”‚
â”‚  â”‚   (HTTP å®¢æˆ·ç«¯)      â”‚  â”‚   (SQLite å­˜å‚¨)     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚             â”‚                        â”‚                                   â”‚
â”‚             â–¼                        â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   secureStorage     â”‚  â”‚      Store          â”‚                       â”‚
â”‚  â”‚   (å¯†ç åŠ å¯†)         â”‚  â”‚   (é…ç½®æŒä¹…åŒ–)       â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Remote Storage                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     WebDAV Server                                â”‚    â”‚
â”‚  â”‚   /PicNexus/                                                     â”‚    â”‚
â”‚  â”‚   â”œâ”€â”€ settings.json   (ç”¨æˆ·é…ç½®)                                  â”‚    â”‚
â”‚  â”‚   â””â”€â”€ history.json    (ä¸Šä¼ å†å²)                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Rust åç«¯æ”¯æŒ

### 2.0 Tauri Commands (`src-tauri/src/main.rs`)

#### WebDAV è¿æ¥æµ‹è¯•

```rust
#[tauri::command]
async fn test_webdav_connection(
  config: WebDAVConfig,
  http_client: tauri::State<'_, HttpClient>
) -> Result<String, AppError>
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `config.url` | `String` | WebDAV æœåŠ¡å™¨ URL |
| `config.username` | `String` | ç”¨æˆ·å |
| `config.password` | `String` | å¯†ç ï¼ˆæ˜æ–‡ä¼ å…¥ï¼Œå†…éƒ¨ç”Ÿæˆ Basic Authï¼‰ |

**å“åº”ç å¤„ç†**ï¼š
- 200/207 â†’ è¿æ¥æˆåŠŸ
- 401/403 â†’ è®¤è¯å¤±è´¥
- 404 â†’ è·¯å¾„ä¸å­˜åœ¨

#### å¯†é’¥ç®¡ç†

```rust
#[tauri::command]
fn get_or_create_secure_key() -> Result<String, AppError>
```

- è¿”å› 256 ä½ AES å¯†é’¥çš„ Base64 ç¼–ç 
- å¯†é’¥å­˜å‚¨åœ¨ç³»ç»Ÿé’¥åŒ™ä¸²ï¼ˆKeyringï¼‰
- **âš ï¸ æ³¨æ„**ï¼šå¯†é’¥ä¸¢å¤±å°†å¯¼è‡´æ‰€æœ‰åŠ å¯†æ•°æ®æ— æ³•æ¢å¤

---

## ä¸‰ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 3.1 WebDAVClient (`src/utils/webdav.ts`)

WebDAV åè®®çš„å®¢æˆ·ç«¯å°è£…ï¼Œæä¾›åŸºç¡€æ–‡ä»¶æ“ä½œã€‚

#### ç±»å®šä¹‰

```typescript
export class WebDAVClient {
  // ä»åŠ å¯†é…ç½®åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆæ¨èï¼‰
  static async fromEncryptedConfig(config: {
    url: string;
    username: string;
    password?: string;           // å·²åºŸå¼ƒï¼Œå‘åå…¼å®¹
    passwordEncrypted?: string;  // åŠ å¯†å­˜å‚¨çš„å¯†ç 
    remotePath?: string;
  }): Promise<WebDAVClient>

  // é™æ€æ–¹æ³•ï¼šå¯†ç åŠ è§£å¯†
  static async encryptPassword(password: string): Promise<string>
  static async decryptPassword(encryptedPassword: string): Promise<string>

  // å®ä¾‹æ–¹æ³•
  async testConnection(): Promise<boolean>              // æµ‹è¯•è¿æ¥
  async putFile(remotePath: string, content: string): Promise<void>  // ä¸Šä¼ 
  async getFile(remotePath: string): Promise<string | null>          // ä¸‹è½½
  async exists(remotePath: string): Promise<boolean>    // æ£€æŸ¥å­˜åœ¨
  async mkDir(remotePath: string): Promise<boolean>     // åˆ›å»ºç›®å½•
  async ensureDir(remotePath: string): Promise<void>    // é€’å½’åˆ›å»ºç›®å½•
}
```

#### å…³é”®å®ç°ç»†èŠ‚

| æ–¹æ³• | HTTP Method | è¶…æ—¶ | å¤‡æ³¨ |
|------|-------------|------|------|
| `testConnection()` | PROPFIND | 10s | Depth: 0 |
| `putFile()` | PUT | 30s | Overwrite: T |
| `getFile()` | GET | 30s | 404 è¿”å› null |
| `mkDir()` | MKCOL | 10s | 405/301/302 è§†ä¸ºå·²å­˜åœ¨ |

#### é”™è¯¯å¤„ç†

```typescript
// HTTP çŠ¶æ€ç æ˜ å°„
401/403 â†’ 'è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
404     â†’ 'è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è¿œç¨‹è·¯å¾„é…ç½®'
507     â†’ 'å­˜å‚¨ç©ºé—´ä¸è¶³ï¼ŒWebDAV æœåŠ¡å™¨ç©ºé—´å·²æ»¡'
5xx     â†’ 'æœåŠ¡å™¨é”™è¯¯ (HTTP xxx)ï¼ŒWebDAV æœåŠ¡å™¨å¯èƒ½æš‚æ—¶ä¸å¯ç”¨'
```

#### âš ï¸ å®‰å…¨æ³¨æ„

- å¯†ç ä½¿ç”¨ `secureStorage.encrypt()` åŠ å¯†å­˜å‚¨
- æ—§ç‰ˆæ˜æ–‡å¯†ç ä»…ç”¨äºè¿ç§»ï¼Œä¼šæ‰“å°è­¦å‘Šæ—¥å¿—
- Basic Auth ä½¿ç”¨ `btoa()` ç¼–ç ï¼Œ**å¿…é¡»ä½¿ç”¨ HTTPS**

#### ğŸ”´ å·²çŸ¥ç¼ºé™·

1. **`btoa()` ä¸æ”¯æŒé ASCII å­—ç¬¦**
   - ç”¨æˆ·å/å¯†ç åŒ…å«ä¸­æ–‡ä¼šæŠ›å‡º `InvalidCharacterError`
   - **ä¿®å¤å»ºè®®**ï¼šä½¿ç”¨ `TextEncoder` + Base64

```typescript
// å½“å‰å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰
const auth = btoa(`${username}:${password}`);

// å»ºè®®ä¿®å¤
function encodeBasicAuth(username: string, password: string): string {
  const encoder = new TextEncoder();
  const bytes = encoder.encode(`${username}:${password}`);
  return btoa(String.fromCharCode(...bytes));
}
```

2. **è¶…æ—¶æ—¶é—´ç¡¬ç¼–ç **
   - `testConnection()`: 10sï¼Œ`putFile()`/`getFile()`: 30s
   - å¤§æ–‡ä»¶æˆ–æ…¢é€Ÿç½‘ç»œå¯èƒ½è¶…æ—¶

3. **URL è·¯å¾„æ‹¼æ¥æœªç¼–ç ç‰¹æ®Šå­—ç¬¦**
   - å¦‚ `remotePath` åŒ…å«ç©ºæ ¼æˆ–ä¸­æ–‡ï¼Œå¯èƒ½å¯¼è‡´è¯·æ±‚å¤±è´¥
   - **å»ºè®®**ï¼šå¯¹è·¯å¾„ç»„ä»¶ä½¿ç”¨ `encodeURIComponent()`

---

### 3.2 useWebDAVSync (`src/composables/useWebDAVSync.ts`)

åŒæ­¥é€»è¾‘çš„æ ¸å¿ƒ Composableï¼Œæä¾›ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å’Œæ“ä½œæ¥å£ã€‚

#### å¯¼å‡ºæ¥å£

```typescript
export function useWebDAVSync() {
  return {
    // å“åº”å¼çŠ¶æ€
    syncStatus: ComputedRef<SyncStatus>,      // åŒæ­¥çŠ¶æ€
    isSyncing: ComputedRef<boolean>,          // æ˜¯å¦æ­£åœ¨åŒæ­¥
    progress: ComputedRef<SyncProgress | null>, // å½“å‰è¿›åº¦
    pendingConflict: ComputedRef<SyncConflict | null>, // å¾…å¤„ç†å†²çª

    // ç”Ÿå‘½å‘¨æœŸ
    loadSyncStatus(): Promise<void>,          // åŠ è½½æŒä¹…åŒ–çŠ¶æ€

    // é…ç½®åŒæ­¥
    uploadSettings(profile, options?): Promise<SyncResult>,
    downloadSettings(profile, options?): Promise<SyncResult>,

    // å†å²è®°å½•åŒæ­¥
    uploadHistory(profile, options?): Promise<SyncResult>,
    downloadHistory(profile, options?): Promise<SyncResult>,

    // å†²çªå¤„ç†
    checkConfigConflict(profile): Promise<SyncConflict | null>,
    setPendingConflict(conflict): void,
    clearPendingConflict(): void,
    resolveConflict(profile, resolution): Promise<SyncResult>,
  }
}
```

#### åŒæ­¥æ¨¡å¼è¯¦è§£

**é…ç½®åŒæ­¥æ¨¡å¼**

| æ¨¡å¼ | æ–¹å‘ | è¡Œä¸º |
|------|------|------|
| `upload` | æœ¬åœ°â†’äº‘ç«¯ | å®Œå…¨è¦†ç›–äº‘ç«¯é…ç½® |
| `download + overwrite` | äº‘ç«¯â†’æœ¬åœ° | å®Œå…¨è¦†ç›–æœ¬åœ°é…ç½® |
| `download + merge` | äº‘ç«¯â†’æœ¬åœ° | ä¿ç•™æœ¬åœ° WebDAV é…ç½®ï¼Œå…¶ä»–ç”¨äº‘ç«¯ |

**å†å²è®°å½•åŒæ­¥æ¨¡å¼**

| æ¨¡å¼ | æ–¹å‘ | è¡Œä¸º |
|------|------|------|
| `force` | æœ¬åœ°â†’äº‘ç«¯ | å®Œå…¨è¦†ç›–äº‘ç«¯ |
| `merge` | åŒå‘ | æŒ‰æ—¶é—´æˆ³åˆå¹¶ï¼Œæœ¬åœ°ä¼˜å…ˆ |
| `incremental` | æœ¬åœ°â†’äº‘ç«¯ | ä»…ä¸Šä¼ äº‘ç«¯ä¸å­˜åœ¨çš„è®°å½• |
| `download + overwrite` | äº‘ç«¯â†’æœ¬åœ° | æ¸…ç©ºæœ¬åœ°ï¼Œå¯¼å…¥äº‘ç«¯ |
| `download + merge` | äº‘ç«¯â†’æœ¬åœ° | ä¿ç•™è¾ƒæ–°è®°å½• |

#### åŒæ­¥æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å§‹åŒæ­¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ isSyncing   â”‚â”€â”€â”€â”€ true â”€â”€â†’ è¿”å›"æ­£åœ¨åŒæ­¥ä¸­"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ false
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isSyncing = true â”‚
â”‚ è®¾ç½®è¿›åº¦ 10%     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»º WebDAV å®¢æˆ·ç«¯â”‚
â”‚ è§£å¯†å¯†ç           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å–æœ¬åœ°/è¿œç¨‹æ•°æ® â”‚
â”‚ è®¾ç½®è¿›åº¦ 40%     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆå¹¶/è¦†ç›–å¤„ç†    â”‚
â”‚ è®¾ç½®è¿›åº¦ 70%     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†™å…¥ç›®æ ‡å­˜å‚¨     â”‚
â”‚ è®¾ç½®è¿›åº¦ 100%    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°åŒæ­¥çŠ¶æ€     â”‚
â”‚ isSyncing = falseâ”‚
â”‚ æ˜¾ç¤º Toast       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.3 useAutoSync (`src/composables/useAutoSync.ts`)

è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨ï¼Œæ”¯æŒå®šæ—¶åå°åŒæ­¥ã€‚

#### é…ç½®å‚æ•°

```typescript
interface AutoSyncOptions {
  interval?: number;       // åŒæ­¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 24h
  syncOnMount?: boolean;   // å¯åŠ¨æ—¶ç«‹å³åŒæ­¥
  syncSettings?: boolean;  // æ˜¯å¦åŒæ­¥é…ç½®
  syncHistory?: boolean;   // æ˜¯å¦åŒæ­¥å†å²è®°å½•
}

// æ—¶é—´çº¦æŸ
const MIN_INTERVAL = 1 * 60 * 60 * 1000;   // æœ€å° 1 å°æ—¶
const MAX_INTERVAL = 720 * 60 * 60 * 1000; // æœ€å¤§ 30 å¤©
```

#### å¯¼å‡ºæ¥å£

```typescript
export function useAutoSync(
  getActiveProfile: () => WebDAVProfile | null,
  options?: AutoSyncOptions
) {
  return {
    // çŠ¶æ€
    isEnabled: ComputedRef<boolean>,
    lastAutoSync: ComputedRef<Date | null>,
    nextAutoSync: ComputedRef<Date | null>,
    lastResult: ComputedRef<'success' | 'partial' | 'failed' | null>,
    lastError: ComputedRef<string | null>,
    isSyncing: ComputedRef<boolean>,
    remainingSeconds: ComputedRef<number | null>,
    remainingTimeFormatted: ComputedRef<string | null>,

    // æ§åˆ¶æ–¹æ³•
    start(): void,                          // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
    stop(): void,                           // åœæ­¢è‡ªåŠ¨åŒæ­¥
    syncNow(): Promise<void>,               // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    updateInterval(hours: number): void,    // æ›´æ–°é—´éš”
  }
}
```

#### âš ï¸ å½“å‰é™åˆ¶

**è‡ªåŠ¨åŒæ­¥åªæ‰§è¡Œä¸Šä¼ æ“ä½œ**ï¼Œä¸ä¼šä¸‹è½½äº‘ç«¯å˜åŒ–ï¼š

```typescript
// useAutoSync.ts:149-163
if (syncSettings) {
  const settingsResult = await uploadSettings(profile);  // åªä¸Šä¼ 
}
if (syncHistory) {
  const historyResult = await uploadHistory(profile, { mode: 'merge' });  // åªä¸Šä¼ 
}
```

è¿™æ„å‘³ç€ï¼š
- å¤šè®¾å¤‡åœºæ™¯ä¸‹ï¼Œè®¾å¤‡ A çš„ä¿®æ”¹ä¸ä¼šè‡ªåŠ¨åŒæ­¥åˆ°è®¾å¤‡ B
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"ä¸‹è½½"æ¥è·å–å…¶ä»–è®¾å¤‡çš„æ›´æ”¹

---

## å››ã€æ•°æ®ç»“æ„

### 4.1 ç±»å‹å®šä¹‰ (`src/config/types.ts`)

#### WebDAV é…ç½®

```typescript
interface WebDAVProfile {
  id: string;                  // å”¯ä¸€æ ‡è¯†ç¬¦
  name: string;                // æ˜¾ç¤ºåç§°ï¼ˆå¦‚"åšæœäº‘"ï¼‰
  url: string;                 // WebDAV æœåŠ¡å™¨ URL
  username: string;            // ç”¨æˆ·å
  password?: string;           // [å·²åºŸå¼ƒ] æ˜æ–‡å¯†ç 
  passwordEncrypted?: string;  // åŠ å¯†å¯†ç 
  remotePath: string;          // è¿œç¨‹è·¯å¾„ï¼ˆå¦‚ /PicNexus/ï¼‰
}

interface WebDAVConfig {
  profiles: WebDAVProfile[];   // é…ç½®åˆ—è¡¨
  activeId: string | null;     // å½“å‰é€‰ä¸­çš„é…ç½® ID
}
```

#### åŒæ­¥çŠ¶æ€

```typescript
interface SyncStatus {
  // é…ç½®åŒæ­¥
  configLastSync: string | null;          // "YYYY-MM-DD HH:mm:ss"
  configSyncResult: 'success' | 'failed' | null;
  configSyncError?: string;

  // å†å²è®°å½•åŒæ­¥
  historyLastSync: string | null;
  historySyncResult: 'success' | 'failed' | null;
  historySyncError?: string;
}
```

#### è‡ªåŠ¨åŒæ­¥é…ç½®

```typescript
interface AutoSyncConfig {
  enabled: boolean;            // æ˜¯å¦å¯ç”¨
  intervalHours: number;       // é—´éš”ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤ 48
}
```

### 4.2 äº‘ç«¯æ–‡ä»¶ç»“æ„

```
{remotePath}/
â”œâ”€â”€ settings.json    # UserConfig çš„ JSON åºåˆ—åŒ–
â””â”€â”€ history.json     # HistoryItem[] çš„ JSON åºåˆ—åŒ–
```

#### settings.json ç¤ºä¾‹

```json
{
  "configVersion": 1,
  "enabledServices": ["weibo", "r2"],
  "availableServices": ["weibo", "r2", "jd"],
  "services": {
    "weibo": { "cookies": "...", "authToken": "..." },
    "r2": { "accountId": "...", "accessKeyId": "...", ... }
  },
  "outputFormat": "direct",
  "webdav": {
    "profiles": [...],
    "activeId": "xxx"
  },
  "autoSync": {
    "enabled": true,
    "intervalHours": 24
  }
}
```

#### history.json ç¤ºä¾‹

```json
[
  {
    "id": "1735123456789_abc123",
    "timestamp": 1735123456789,
    "localFileName": "screenshot.png",
    "filePath": "C:/Users/.../screenshot.png",
    "primaryService": "weibo",
    "results": [
      {
        "serviceId": "weibo",
        "status": "success",
        "url": "https://...",
        "thumbnailUrl": "https://..."
      }
    ],
    "generatedLink": "![](https://...)",
    "linkCheckStatus": { ... },
    "linkCheckSummary": { ... }
  }
]
```

### 4.3 æœ¬åœ°å­˜å‚¨

| æ–‡ä»¶ | å†…å®¹ | åŠ å¯† |
|------|------|------|
| `.settings.dat` | UserConfig | âœ… AES åŠ å¯† |
| `.sync-status.dat` | SyncStatus | âœ… AES åŠ å¯† |
| `history.db` | SQLite æ•°æ®åº“ | âŒ æ˜æ–‡ |

---

## äº”ã€å†å²è®°å½•åˆå¹¶ç®—æ³•

### 5.1 å½“å‰å®ç° (`HistoryDatabase.importFromJSON`)

```typescript
// src/services/HistoryDatabase.ts:486-492
if (mergeStrategy === 'merge') {
  const existing = await this.getById(item.id);
  if (existing && existing.timestamp >= item.timestamp) {
    continue; // è·³è¿‡è¾ƒæ—§çš„è®°å½•
  }
}
await this.upsert(item);
```

**ç­–ç•¥**ï¼šæŒ‰ `id` åŒ¹é…ï¼Œä¿ç•™ `timestamp` è¾ƒå¤§çš„è®°å½•ã€‚

### 5.2 ä¸Šä¼ åˆå¹¶é€»è¾‘ (`useWebDAVSync.uploadHistory`)

```typescript
// src/composables/useWebDAVSync.ts:383-392
const itemMap = new Map<string, HistoryItem>();
cloudItems.forEach(item => itemMap.set(item.id, item));
localItems.forEach(item => {
  const existing = itemMap.get(item.id);
  if (!existing || (item.timestamp > (existing.timestamp || 0))) {
    itemMap.set(item.id, item);
  }
});
uploadItems = Array.from(itemMap.values());
```

**ç­–ç•¥**ï¼š
1. äº‘ç«¯æ•°æ®å…¨éƒ¨åŠ å…¥ Map
2. æœ¬åœ°æ•°æ®æŒ‰æ—¶é—´æˆ³è¦†ç›–ï¼ˆæœ¬åœ°è¾ƒæ–°åˆ™è¦†ç›–ï¼‰
3. åˆå¹¶åä¸Šä¼ 

### 5.3 âš ï¸ æ½œåœ¨é—®é¢˜

**åœºæ™¯**ï¼šè®¾å¤‡ A ä¿®æ”¹äº†æ ‡ç­¾ï¼Œè®¾å¤‡ B ä¿®æ”¹äº†è¯„åˆ†ï¼Œä¸¤è€… timestamp ä¸åŒã€‚

**ç»“æœ**ï¼šåªä¿ç•™ timestamp è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œå¦ä¸€è®¾å¤‡çš„ä¿®æ”¹ä¸¢å¤±ã€‚

**å»ºè®®**ï¼šå®ç°å­—æ®µçº§åˆå¹¶ï¼ˆè§ä¼˜åŒ–æ–¹æ¡ˆï¼‰ã€‚

---

## å…­ã€å·²çŸ¥é—®é¢˜ä¸å¾…ä¼˜åŒ–

### 6.1 ğŸ”´ ä»£ç é‡å¤ï¼ˆä¸¥é‡ï¼‰

**é—®é¢˜**ï¼š`SettingsView.vue` å’Œ `useWebDAVSync.ts` å­˜åœ¨ **å®Œå…¨ç‹¬ç«‹çš„** åŒæ­¥é€»è¾‘å®ç°ã€‚

| åŠŸèƒ½ | SettingsView.vue | useWebDAVSync.ts |
|------|------------------|------------------|
| ä¸Šä¼ é…ç½® | `uploadSettingsCloud()` :1347 | `uploadSettings()` :226 |
| ä¸‹è½½é…ç½®(è¦†ç›–) | `downloadSettingsOverwrite()` :1378 | `downloadSettings({mode:'overwrite'})` :271 |
| ä¸‹è½½é…ç½®(åˆå¹¶) | `downloadSettingsMerge()` :1434 | `downloadSettings({mode:'merge'})` :271 |
| ä¸Šä¼ å†å² | `uploadHistoryForce/Merge/Incremental()` | `uploadHistory()` :343 |
| ä¸‹è½½å†å² | `downloadHistoryOverwrite/Merge()` | `downloadHistory()` :427 |

**ä»£ç è¡Œæ•°**ï¼šSettingsView ä¸­çº¦ **540 è¡Œ**åŒæ­¥ç›¸å…³ä»£ç æ˜¯å†—ä½™çš„ã€‚

**è¡Œä¸ºå·®å¼‚é£é™©**ï¼š
```typescript
// SettingsView.vue:1359 - ä½¿ç”¨ 2 ç©ºæ ¼ç¼©è¿›
const jsonContent = JSON.stringify(config, null, 2);

// useWebDAVSync.ts:249 - ä¹Ÿæ˜¯ 2 ç©ºæ ¼ï¼Œä½†æ— å˜é‡åå·®å¼‚é£é™©
await client.putFile(remotePath, JSON.stringify(config, null, 2));
```

**å½“å‰ä¸¤å¥—ä»£ç çš„è°ƒç”¨è€…**ï¼š
- `SettingsView.vue` çš„æŒ‰é’®ç»‘å®š â†’ è°ƒç”¨è‡ªèº«æ–¹æ³•
- `useAutoSync.ts` â†’ è°ƒç”¨ composable æ–¹æ³•

**å½±å“**ï¼š
- ä¿®å¤ Bug éœ€è¦æ”¹ä¸¤å¤„
- åŠŸèƒ½å¢å¼ºéœ€è¦åŒæ­¥ä¸¤å¤„
- Toast æ¶ˆæ¯å’Œé”™è¯¯å¤„ç†å¯èƒ½ä¸ä¸€è‡´

**å»ºè®®**ï¼šåˆ é™¤ SettingsView ä¸­çš„å®ç°ï¼Œç»Ÿä¸€è°ƒç”¨ composableã€‚

### 6.2 è‡ªåŠ¨åŒæ­¥å•å‘

**é—®é¢˜**ï¼š`useAutoSync` åªæ‰§è¡Œä¸Šä¼ ï¼Œä¸ä¸‹è½½äº‘ç«¯å˜åŒ–ã€‚

**å½±å“**ï¼šå¤šè®¾å¤‡åœºæ™¯æ•°æ®ä¸åŒæ­¥ã€‚

**å»ºè®®**ï¼š
- æ·»åŠ  `syncDirection: 'upload' | 'bidirectional'` é…ç½®
- åŒå‘æ¨¡å¼ä¸‹å…ˆä¸‹è½½åˆå¹¶ï¼Œå†ä¸Šä¼ 

### 6.3 å¹¶å‘æ§åˆ¶ä¸å®Œæ•´

#### æœ¬åœ°å¹¶å‘ï¼ˆå·²è§£å†³ï¼‰

`Store` ç±»ä½¿ç”¨ `Mutex` å®ç°æœ¬åœ°è¯»-ä¿®æ”¹-å†™çš„åŸå­æ€§ï¼š

```typescript
// src/store.ts:54-61
async withLock<T>(fn: () => Promise<T>): Promise<T> {
  await this.acquire();
  try {
    return await fn();
  } finally {
    this.release();
  }
}
```

#### åˆ†å¸ƒå¼å¹¶å‘ï¼ˆæœªè§£å†³ï¼‰

**é—®é¢˜**ï¼šå¤šè®¾å¤‡åŒæ—¶åŒæ­¥å¯èƒ½å¯¼è‡´æ•°æ®è¦†ç›–ã€‚

**åœºæ™¯**ï¼š
1. è®¾å¤‡ A å¼€å§‹ä¸Šä¼ å†å²è®°å½•
2. è®¾å¤‡ B åŒæ—¶å¼€å§‹ä¸Šä¼ 
3. è®¾å¤‡ A å®Œæˆä¸Šä¼ 
4. è®¾å¤‡ B å®Œæˆä¸Šä¼ ï¼Œè¦†ç›–äº† A çš„æ•°æ®

**ç°çŠ¶**ï¼šä»…æœ‰ `isSyncing` æœ¬åœ°æ£€æŸ¥ï¼Œæ— è·¨è®¾å¤‡åè°ƒã€‚

**å»ºè®®**ï¼šåœ¨ WebDAV ä¸Šåˆ›å»º `.sync.lock` æ–‡ä»¶å®ç°åˆ†å¸ƒå¼é”ã€‚

### 6.4 ç¼ºå°‘ ETag æ”¯æŒ

**é—®é¢˜**ï¼šæ¯æ¬¡åŒæ­¥éƒ½å®Œæ•´ä¸‹è½½/ä¸Šä¼ æ–‡ä»¶ã€‚

**å½±å“**ï¼šå¤§æ–‡ä»¶åŒæ­¥æ•ˆç‡ä½ï¼Œæ— æ³•åˆ¤æ–­æ˜¯å¦çœŸçš„æœ‰å˜åŒ–ã€‚

**å»ºè®®**ï¼š
- ä¸Šä¼ æ—¶è®°å½• ETag
- ä¸‹è½½å‰ HEAD è¯·æ±‚æ£€æŸ¥å˜åŒ–
- æ— å˜åŒ–åˆ™è·³è¿‡

### 6.5 å†å²è®°å½•åˆå¹¶å¯èƒ½ä¸¢æ•°æ®

**é—®é¢˜**ï¼šåŒä¸€è®°å½•åœ¨ä¸¤ç«¯ä¿®æ”¹ä¸åŒå­—æ®µï¼Œåªä¿ç•™æ—¶é—´æˆ³è¾ƒæ–°çš„ç‰ˆæœ¬ã€‚

**å»ºè®®**ï¼šå®ç°å­—æ®µçº§åˆå¹¶ï¼Œåˆ†åˆ«å¤„ç† `results`ã€`linkCheckStatus` ç­‰å­—æ®µã€‚

### 6.6 è¾¹ç¼˜æƒ…å†µæœªå¤„ç†

| åœºæ™¯ | å½“å‰è¡Œä¸º | é£é™© |
|------|----------|------|
| JSON è§£æå¤±è´¥ | æŠ›å‡ºå¼‚å¸¸ï¼Œæ˜¾ç¤ºé”™è¯¯ Toast | âœ… å·²å¤„ç† |
| äº‘ç«¯æ–‡ä»¶ä¸å­˜åœ¨ | `getFile()` è¿”å› null | âœ… å·²å¤„ç† |
| ç½‘ç»œè¶…æ—¶ | 30 ç§’å AbortController ä¸­æ–­ | âš ï¸ æ— é‡è¯• |
| ç£ç›˜ç©ºé—´ä¸è¶³ | å†™å…¥å¤±è´¥ | âŒ æ— ç‰¹æ®Šå¤„ç† |
| å†å²è®°å½•è¿‡å¤§ï¼ˆ>100MBï¼‰ | å†…å­˜æº¢å‡ºé£é™© | âŒ æ— åˆ†é¡µ/æµå¼å¤„ç† |
| æ–‡ä»¶åå«ç‰¹æ®Šå­—ç¬¦ | è·¯å¾„æ‹¼æ¥å¯èƒ½å‡ºé”™ | âŒ æœªç¼–ç  |
| é…ç½®æ ¼å¼ç‰ˆæœ¬ä¸åŒ¹é… | `migrateConfig()` å¤„ç† | âœ… å·²å¤„ç† |

### 6.7 é…ç½®åˆ·æ–°æœºåˆ¶ä¸å®Œå–„

**é—®é¢˜**ï¼šä¸‹è½½é…ç½®åéœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½ç”Ÿæ•ˆã€‚

```typescript
// SettingsView.vue:1417-1419
setTimeout(() => {
  toast.info('è¯·åˆ·æ–°é¡µé¢ä»¥ä½¿é…ç½®ç”Ÿæ•ˆ');
}, 1000);
```

**åŸå› **ï¼šVue å“åº”å¼ç³»ç»Ÿæ— æ³•æ£€æµ‹åˆ° Store å¤–éƒ¨çš„å˜åŒ–ã€‚

**å»ºè®®**ï¼š
1. å®ç°é…ç½®å˜æ›´äº‹ä»¶ï¼Œè§¦å‘ç»„ä»¶é‡æ–°åŠ è½½
2. æˆ–ä½¿ç”¨ `window.location.reload()` è‡ªåŠ¨åˆ·æ–°

---

## ä¸ƒã€å®‰å…¨è€ƒè™‘

### 7.1 åŠ å¯†æœºåˆ¶è¯¦è§£ (`src/crypto.ts`)

#### åŠ å¯†ç®—æ³•
- **ç®—æ³•**: AES-256-GCMï¼ˆè®¤è¯åŠ å¯†ï¼‰
- **å¯†é’¥**: 256 ä½ï¼Œå­˜å‚¨åœ¨ç³»ç»Ÿé’¥åŒ™ä¸²
- **IV**: 12 å­—èŠ‚éšæœºæ•°ï¼Œæ¯æ¬¡åŠ å¯†ä¸åŒ
- **æ ¼å¼**: `PNXENC:Base64(IV[12] + Ciphertext + AuthTag[16])`

```typescript
// åŠ å¯†æ•°æ®è¯†åˆ«
const ENCRYPTED_MAGIC_PREFIX = 'PNXENC:';

function isEncryptedData(data: string): boolean {
  return data.startsWith(ENCRYPTED_MAGIC_PREFIX);
}
```

#### å¯†é’¥ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯†é’¥ç®¡ç†æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. åº”ç”¨é¦–æ¬¡å¯åŠ¨                                         â”‚
â”‚     â””â”€ Rust: get_or_create_secure_key()                 â”‚
â”‚         â”œâ”€ æ£€æŸ¥ç³»ç»Ÿé’¥åŒ™ä¸²æ˜¯å¦æœ‰å¯†é’¥                       â”‚
â”‚         â”œâ”€ æ—  â†’ ç”Ÿæˆ 256 ä½éšæœºå¯†é’¥å¹¶å­˜å‚¨                 â”‚
â”‚         â””â”€ æœ‰ â†’ è¯»å–ç°æœ‰å¯†é’¥                             â”‚
â”‚                                                         â”‚
â”‚  2. å‰ç«¯åˆå§‹åŒ–                                           â”‚
â”‚     â””â”€ SecureStorage.init()                             â”‚
â”‚         â”œâ”€ invoke('get_or_create_secure_key')           â”‚
â”‚         â””â”€ crypto.subtle.importKey() â†’ CryptoKey        â”‚
â”‚                                                         â”‚
â”‚  3. åŠ å¯†/è§£å¯†æ“ä½œ                                        â”‚
â”‚     â””â”€ SecureStorage.encrypt() / decrypt()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### âš ï¸ å¯†é’¥ä¸¢å¤±é£é™©

| åœºæ™¯ | åæœ | æ¢å¤æ–¹æ¡ˆ |
|------|------|----------|
| ç³»ç»Ÿé’¥åŒ™ä¸²æ¸…ç©º | æ‰€æœ‰åŠ å¯†æ•°æ®æ— æ³•è§£å¯† | éœ€é‡æ–°é…ç½®æ‰€æœ‰å›¾åºŠ |
| ç”¨æˆ·è¿ç§»åˆ°æ–°ç”µè„‘ | æ—§é…ç½®æ— æ³•ä½¿ç”¨ | éœ€ä»äº‘ç«¯ä¸‹è½½ï¼ˆå¦‚æœ‰å¤‡ä»½ï¼‰ |
| Keyring æœåŠ¡ä¸å¯ç”¨ | å¯†é’¥è·å–å¤±è´¥ | åº”ç”¨æ— æ³•å¯åŠ¨ |

### 7.2 å¯†ç å­˜å‚¨

```typescript
// ä¿å­˜æ—¶åŠ å¯†
const encrypted = await WebDAVClient.encryptPassword(password);
profile.passwordEncrypted = encrypted;
delete profile.password;

// ä½¿ç”¨æ—¶è§£å¯†
const client = await WebDAVClient.fromEncryptedConfig(profile);
```

### 7.3 ä¼ è¾“å®‰å…¨

- WebDAV URL **å¿…é¡»ä½¿ç”¨ HTTPS**
- Basic Auth åœ¨ HTTP ä¸‹ä¼šæš´éœ²å¯†ç 
- **âš ï¸ å½“å‰æœªåœ¨ UI å±‚å¼ºåˆ¶æ ¡éªŒ URL scheme**

### 7.4 æ•æ„Ÿæ•°æ®å¤„ç†

| æ•°æ® | ä½ç½® | åŠ å¯† | é£é™©è¯„ä¼° |
|------|------|------|----------|
| å›¾åºŠ Token/Cookie | `.settings.dat` | âœ… AES-GCM | ä½ |
| WebDAV å¯†ç  | `.settings.dat` | âœ… AES-GCM | ä½ |
| å†å²è®°å½• | `history.db` | âŒ æ˜æ–‡ | ä¸­ï¼ˆå«å›¾ç‰‡ URLï¼Œéšç§é£é™©ï¼‰ |
| äº‘ç«¯é…ç½® | `settings.json` | âŒ æ˜æ–‡ | **é«˜ï¼ˆå«å®Œæ•´ Tokenï¼‰** |
| äº‘ç«¯å†å² | `history.json` | âŒ æ˜æ–‡ | ä¸­ |

#### ğŸ”´ ä¸¥é‡å®‰å…¨éšæ‚£

**äº‘ç«¯ `settings.json` åŒ…å«æ˜æ–‡æ•æ„Ÿæ•°æ®**ï¼š
- å¾®åš Cookie å’Œ AuthToken
- R2/S3 AccessKeyId å’Œ SecretAccessKey
- å…¶ä»–å›¾åºŠçš„è®¤è¯ä¿¡æ¯

**é£é™©**ï¼šWebDAV æœåŠ¡å™¨è¢«å…¥ä¾µæˆ–é…ç½®é”™è¯¯å¯¼è‡´å…¬å¼€è®¿é—®æ—¶ï¼Œæ”»å‡»è€…å¯è·å–æ‰€æœ‰å›¾åºŠå‡­æ®ã€‚

**ç¼“è§£å»ºè®®**ï¼š
1. æ–‡æ¡£ä¸­å¼ºè°ƒä½¿ç”¨ç§æœ‰ WebDAV æœåŠ¡å™¨
2. æœªæ¥è€ƒè™‘å¯¹äº‘ç«¯é…ç½®ä¹Ÿè¿›è¡Œå®¢æˆ·ç«¯åŠ å¯†

---

## å…«ã€è°ƒè¯•æŒ‡å—

### 8.1 æ—¥å¿—è¾“å‡º

```typescript
// å¼€å¯è¯¦ç»†æ—¥å¿—
console.log('[WebDAV] ...');      // å®¢æˆ·ç«¯æ“ä½œ
console.log('[WebDAVåŒæ­¥] ...'); // åŒæ­¥é€»è¾‘
console.log('[è‡ªåŠ¨åŒæ­¥] ...');   // å®šæ—¶è°ƒåº¦
console.log('[HistoryDB] ...');  // æ•°æ®åº“æ“ä½œ
```

### 8.2 å¸¸è§é”™è¯¯æ’æŸ¥

| é”™è¯¯ä¿¡æ¯ | å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• |
|----------|----------|----------|
| è®¤è¯å¤±è´¥ | ç”¨æˆ·å/å¯†ç é”™è¯¯ | æ£€æŸ¥ WebDAV å‡­æ® |
| è·¯å¾„ä¸å­˜åœ¨ | remotePath é…ç½®é”™è¯¯ | ç¡®è®¤è·¯å¾„ä»¥ `/` å¼€å¤´ |
| å¯†ç è§£å¯†å¤±è´¥ | åŠ å¯†æ•°æ®æŸå | é‡æ–°ä¿å­˜é…ç½® |
| å­˜å‚¨ç©ºé—´ä¸è¶³ | WebDAV æœåŠ¡å™¨æ»¡ | æ¸…ç†æœåŠ¡å™¨ç©ºé—´ |

### 8.3 æµ‹è¯•è¿æ¥

```typescript
const client = await WebDAVClient.fromEncryptedConfig(profile);
const success = await client.testConnection();
console.log('è¿æ¥æµ‹è¯•:', success ? 'æˆåŠŸ' : 'å¤±è´¥');
```

---

## ä¹ã€API å¿«é€Ÿå‚è€ƒ

### 9.1 WebDAVClient

| æ–¹æ³• | è¿”å›å€¼ | è¯´æ˜ |
|------|--------|------|
| `fromEncryptedConfig(config)` | `Promise<WebDAVClient>` | å·¥å‚æ–¹æ³• |
| `testConnection()` | `Promise<boolean>` | æµ‹è¯•è¿æ¥ |
| `putFile(path, content)` | `Promise<void>` | ä¸Šä¼ æ–‡ä»¶ |
| `getFile(path)` | `Promise<string \| null>` | ä¸‹è½½æ–‡ä»¶ |
| `exists(path)` | `Promise<boolean>` | æ£€æŸ¥å­˜åœ¨ |
| `ensureDir(path)` | `Promise<void>` | åˆ›å»ºç›®å½• |

### 9.2 useWebDAVSync

| æ–¹æ³• | è¿”å›å€¼ | è¯´æ˜ |
|------|--------|------|
| `uploadSettings(profile)` | `Promise<SyncResult>` | ä¸Šä¼ é…ç½® |
| `downloadSettings(profile, {mode})` | `Promise<SyncResult>` | ä¸‹è½½é…ç½® |
| `uploadHistory(profile, {mode})` | `Promise<SyncResult>` | ä¸Šä¼ å†å² |
| `downloadHistory(profile, {mode})` | `Promise<SyncResult>` | ä¸‹è½½å†å² |

### 9.3 useAutoSync

| æ–¹æ³• | è¿”å›å€¼ | è¯´æ˜ |
|------|--------|------|
| `start()` | `void` | å¯åŠ¨è‡ªåŠ¨åŒæ­¥ |
| `stop()` | `void` | åœæ­¢è‡ªåŠ¨åŒæ­¥ |
| `syncNow()` | `Promise<void>` | ç«‹å³æ‰§è¡Œ |
| `updateInterval(hours)` | `void` | æ›´æ–°é—´éš” |

---

## åã€å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| v2.10 | 2025-01 | æå– composableï¼Œç»Ÿä¸€çŠ¶æ€ç®¡ç† |
| v2.9 | 2024-12 | æ·»åŠ è‡ªåŠ¨åŒæ­¥åŠŸèƒ½ |
| v2.8 | 2024-11 | æ”¯æŒå¤š WebDAV é…ç½® |
| v2.7 | 2024-10 | å¯†ç åŠ å¯†å­˜å‚¨ |
| v2.0 | 2024-09 | åˆå§‹ WebDAV åŒæ­¥å®ç° |
