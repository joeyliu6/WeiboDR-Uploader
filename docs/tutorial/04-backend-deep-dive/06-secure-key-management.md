# 4.6 å®‰å…¨å¯†é’¥ç®¡ç†ç³»ç»Ÿè¯¦è§£

## å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š
- ç³»ç»Ÿé’¥åŒ™ä¸²ï¼ˆKeyringï¼‰çš„å·¥ä½œåŸç†
- å¦‚ä½•ä½¿ç”¨ `keyring` crate å­˜å‚¨æ•æ„Ÿæ•°æ®
- å¯†é’¥ç”Ÿæˆå’Œå­˜å‚¨çš„æœ€ä½³å®è·µ
- è·¨å¹³å°å¯†é’¥å­˜å‚¨ä½ç½®
- ä¸ºä»€ä¹ˆä¸åº”è¯¥å°†å¯†é’¥å­˜å‚¨åœ¨ä»£ç æˆ–é…ç½®æ–‡ä»¶ä¸­
- Base64 ç¼–ç åœ¨å¯†é’¥ç®¡ç†ä¸­çš„åº”ç”¨

## å‰ç½®çŸ¥è¯†

- åŠ å¯†åŸºç¡€çŸ¥è¯†ï¼ˆAES-GCMã€å¯†é’¥é•¿åº¦ï¼‰
- Rust é”™è¯¯å¤„ç†ï¼ˆResult ç±»å‹ï¼‰
- æ“ä½œç³»ç»Ÿå®‰å…¨å­˜å‚¨æ¦‚å¿µ

---

## æ ¸å¿ƒå†…å®¹

### ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨å¯†é’¥ç®¡ç†ï¼Ÿ

#### é—®é¢˜åœºæ™¯

**æ–¹æ¡ˆ Aï¼šå¯†é’¥ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼ˆâŒ æåº¦ä¸å®‰å…¨ï¼‰**

```rust
// âŒ æ°¸è¿œä¸è¦è¿™æ ·åšï¼
const ENCRYPTION_KEY: &str = "super_secret_key_12345";

fn encrypt(data: &str) -> String {
    // ä½¿ç”¨ç¡¬ç¼–ç çš„å¯†é’¥åŠ å¯†
    aes_encrypt(data, ENCRYPTION_KEY)
}
```

**å®‰å…¨é—®é¢˜**ï¼š
- âŒ æºä»£ç æ³„éœ² â†’ å¯†é’¥æ³„éœ²
- âŒ Git å†å²è®°å½•æ°¸ä¹…ä¿å­˜å¯†é’¥
- âŒ ä»»ä½•èƒ½è®¿é—®ä»£ç çš„äººéƒ½èƒ½çœ‹åˆ°å¯†é’¥

---

**æ–¹æ¡ˆ Bï¼šå¯†é’¥å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼ˆâŒ ä¸å®‰å…¨ï¼‰**

```json
{
  "encryptionKey": "super_secret_key_12345"
}
```

**å®‰å…¨é—®é¢˜**ï¼š
- âŒ é…ç½®æ–‡ä»¶å¯è¢«å…¶ä»–ç¨‹åºè¯»å–
- âŒ ç”¨æˆ·å¤‡ä»½é…ç½®æ–‡ä»¶æ—¶å¯†é’¥ä¹Ÿè¢«å¤‡ä»½
- âŒ æ²¡æœ‰æ“ä½œç³»ç»Ÿçº§ä¿æŠ¤

---

**æ–¹æ¡ˆ Cï¼šä½¿ç”¨ç³»ç»Ÿé’¥åŒ™ä¸²ï¼ˆâœ… å®‰å…¨ï¼‰**

```rust
use keyring::Entry;

// ä»ç³»ç»Ÿé’¥åŒ™ä¸²è¯»å–å¯†é’¥
let entry = Entry::new("com.weibodr.uploader", "encryption_key")?;
let key = entry.get_password()?;
```

**å®‰å…¨ä¼˜åŠ¿**ï¼š
- âœ… æ“ä½œç³»ç»Ÿçº§åŠ å¯†ä¿æŠ¤
- âœ… åªæœ‰å½“å‰ç”¨æˆ·å¯è®¿é—®
- âœ… éœ€è¦ç”¨æˆ·è®¤è¯ï¼ˆWindows: æŒ‡çº¹/PINï¼ŒmacOS: å¯†ç /TouchIDï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥ï¼ˆmacOS iCloud Keychainï¼‰

---

## 1. ç³»ç»Ÿé’¥åŒ™ä¸²å·¥ä½œåŸç†

### 1.1 è·¨å¹³å°å®ç°

| æ“ä½œç³»ç»Ÿ | å­˜å‚¨ä½ç½® | ä¿æŠ¤æœºåˆ¶ |
|---------|---------|---------|
| **Windows** | Credential Managerï¼ˆå‡­æ®ç®¡ç†å™¨ï¼‰ | DPAPI åŠ å¯† |
| **macOS** | Keychainï¼ˆé’¥åŒ™ä¸²ï¼‰ | ç¡¬ä»¶åŠ å¯†ï¼ˆT2/Secure Enclaveï¼‰ |
| **Linux** | Secret Service API | GNOME Keyring / KWallet |

---

### 1.2 Windows Credential Manager

**å­˜å‚¨è·¯å¾„**ï¼š
```
æ§åˆ¶é¢æ¿ â†’ ç”¨æˆ·è´¦æˆ· â†’ å‡­æ®ç®¡ç†å™¨ â†’ Windows å‡­æ®
```

**æŸ¥çœ‹å­˜å‚¨çš„å¯†é’¥**ï¼š
```
åº”ç”¨ç¨‹åº: com.weibodr.uploader.secure
ç”¨æˆ·å:   config_encryption_key
å¯†ç :     [Base64 ç¼–ç çš„å¯†é’¥]
```

**ä¿æŠ¤æœºåˆ¶ï¼ˆDPAPIï¼‰**ï¼š
- âœ… ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç æ´¾ç”Ÿå¯†é’¥
- âœ… åªæœ‰å½“å‰ç”¨æˆ·å¯è§£å¯†
- âœ… å…¶ä»–ç”¨æˆ·æ— æ³•è®¿é—®

---

### 1.3 macOS Keychain

**å­˜å‚¨è·¯å¾„**ï¼š
```
åº”ç”¨ç¨‹åº â†’ å®ç”¨å·¥å…· â†’ é’¥åŒ™ä¸²è®¿é—® â†’ ç™»å½•é’¥åŒ™ä¸²
```

**æŸ¥çœ‹å­˜å‚¨çš„å¯†é’¥**ï¼š
```
åç§°:   config_encryption_key
ç§ç±»:   åº”ç”¨ç¨‹åºå¯†ç 
è´¦æˆ·:   config_encryption_key
ä½ç½®:   com.weibodr.uploader.secure
```

**ä¿æŠ¤æœºåˆ¶**ï¼š
- âœ… T2 èŠ¯ç‰‡ / Secure Enclave ç¡¬ä»¶åŠ å¯†
- âœ… æ”¯æŒ TouchID / FaceID è®¤è¯
- âœ… iCloud åŒæ­¥ï¼ˆå¯é€‰ï¼‰

---

### 1.4 Linux Secret Service

**å®ç°**ï¼š
- GNOME Keyringï¼ˆGNOME æ¡Œé¢ï¼‰
- KWalletï¼ˆKDE æ¡Œé¢ï¼‰

**ä¿æŠ¤æœºåˆ¶**ï¼š
- âœ… ä½¿ç”¨ç”¨æˆ·ç™»å½•å¯†ç åŠ å¯†
- âœ… D-Bus API è®¿é—®æ§åˆ¶

---

## 2. é¡¹ç›®å®ç°

### 2.1 ä¾èµ–é…ç½®

**æ–‡ä»¶ä½ç½®**ï¼š`src-tauri/Cargo.toml`

```toml
[dependencies]
keyring = "2"
rand = "0.8"
base64 = "0.21"
```

**crate è¯´æ˜**ï¼š
- `keyring` â†’ è·¨å¹³å°é’¥åŒ™ä¸²è®¿é—®
- `rand` â†’ ç”Ÿæˆéšæœºå¯†é’¥
- `base64` â†’ å¯†é’¥ç¼–ç ï¼ˆäºŒè¿›åˆ¶ â†’ æ–‡æœ¬ï¼‰

---

### 2.2 æœåŠ¡åå’Œå¯†é’¥åå®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`src-tauri/src/main.rs (Line 36-38)`

```rust
// å®šä¹‰æœåŠ¡åï¼Œé˜²æ­¢ä¸å…¶ä»–åº”ç”¨å†²çª
const SERVICE_NAME: &str = "com.weibodr.uploader.secure";
const KEY_NAME: &str = "config_encryption_key";
```

**ä¸ºä»€ä¹ˆä½¿ç”¨åå‘åŸŸåæ ¼å¼**ï¼Ÿ
- âœ… é˜²æ­¢å‘½åå†²çªï¼ˆå¦‚å…¶ä»–åº”ç”¨ä¹Ÿå« `uploader`ï¼‰
- âœ… ç¬¦åˆè¡Œä¸šæƒ¯ä¾‹ï¼ˆç±»ä¼¼ iOS Bundle IDã€Android Package Nameï¼‰

**ç¤ºä¾‹**ï¼š
```
com.weibodr.uploader.secure  â†’ WeiboDR-Uploader åº”ç”¨
com.example.myapp            â†’ å…¶ä»–åº”ç”¨
```

---

## 3. è·å–æˆ–åˆ›å»ºå¯†é’¥å‘½ä»¤

### 3.1 å®Œæ•´å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`src-tauri/src/main.rs (Line 1343-1375)`

```rust
/// è·å–æˆ–åˆ›å»ºåŠ å¯†å¯†é’¥
///
/// ä»ç³»ç»Ÿé’¥åŒ™ä¸²ä¸­è·å–åŠ å¯†å¯†é’¥ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„ 32 å­—èŠ‚ (256 ä½) éšæœºå¯†é’¥
///
/// # è¿”å›
/// è¿”å› `Result<String, String>`ï¼ŒæˆåŠŸæ—¶è¿”å› Base64 ç¼–ç çš„å¯†é’¥ï¼Œå¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯
#[tauri::command]
fn get_or_create_secure_key() -> Result<String, String> {
    let entry = Entry::new(SERVICE_NAME, KEY_NAME).map_err(|e| {
        format!("æ— æ³•è®¿é—®ç³»ç»Ÿé’¥åŒ™ä¸²: {}", e)
    })?;

    match entry.get_password() {
        Ok(key) => {
            eprintln!("[å¯†é’¥ç®¡ç†] ä»é’¥åŒ™ä¸²è¯»å–ç°æœ‰å¯†é’¥");
            Ok(key)
        },
        Err(_) => {
            // å¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ 32 å­—èŠ‚ (256 ä½) éšæœºå¯†é’¥
            eprintln!("[å¯†é’¥ç®¡ç†] ç”Ÿæˆæ–°çš„åŠ å¯†å¯†é’¥");
            let mut key_bytes = [0u8; 32];
            rand::thread_rng().fill(&mut key_bytes);
            let new_key = general_purpose::STANDARD.encode(key_bytes);

            // å­˜å…¥ç³»ç»Ÿé’¥åŒ™ä¸²
            entry.set_password(&new_key).map_err(|e| {
                format!("æ— æ³•ä¿å­˜å¯†é’¥åˆ°ç³»ç»Ÿé’¥åŒ™ä¸²: {}", e)
            })?;

            eprintln!("[å¯†é’¥ç®¡ç†] âœ“ æ–°å¯†é’¥å·²ä¿å­˜åˆ°ç³»ç»Ÿé’¥åŒ™ä¸²");
            Ok(new_key)
        }
    }
}
```

---

### 3.2 é€æ­¥ä»£ç è§£æ

#### æ­¥éª¤ 1ï¼šåˆ›å»ºé’¥åŒ™ä¸²æ¡ç›®

```rust
let entry = Entry::new(SERVICE_NAME, KEY_NAME).map_err(|e| {
    format!("æ— æ³•è®¿é—®ç³»ç»Ÿé’¥åŒ™ä¸²: {}", e)
})?;
```

**Entry::new å‚æ•°**ï¼š
- `SERVICE_NAME` â†’ æœåŠ¡æ ‡è¯†ï¼ˆ`"com.weibodr.uploader.secure"`ï¼‰
- `KEY_NAME` â†’ å¯†é’¥æ ‡è¯†ï¼ˆ`"config_encryption_key"`ï¼‰

**ç­‰ä»·äº**ï¼š
```
Windows: åœ¨ Credential Manager ä¸­æŸ¥æ‰¾
  Target: com.weibodr.uploader.secure
  User:   config_encryption_key

macOS: åœ¨ Keychain ä¸­æŸ¥æ‰¾
  Where:  com.weibodr.uploader.secure
  Name:   config_encryption_key
```

---

#### æ­¥éª¤ 2ï¼šå°è¯•è¯»å–ç°æœ‰å¯†é’¥

```rust
match entry.get_password() {
    Ok(key) => {
        eprintln!("[å¯†é’¥ç®¡ç†] ä»é’¥åŒ™ä¸²è¯»å–ç°æœ‰å¯†é’¥");
        Ok(key)
    },
    Err(_) => {
        // å¯†é’¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å¯†é’¥
    }
}
```

**åœºæ™¯**ï¼š
```
é¦–æ¬¡è¿è¡Œåº”ç”¨:
  get_password() â†’ Err (å¯†é’¥ä¸å­˜åœ¨)
  â†’ ç”Ÿæˆæ–°å¯†é’¥

ç¬¬äºŒæ¬¡è¿è¡Œåº”ç”¨:
  get_password() â†’ Ok(key)
  â†’ è¿”å›ç°æœ‰å¯†é’¥
```

---

#### æ­¥éª¤ 3ï¼šç”Ÿæˆéšæœºå¯†é’¥

```rust
let mut key_bytes = [0u8; 32];
rand::thread_rng().fill(&mut key_bytes);
```

**ä»£ç è§£æ**ï¼š
- `[0u8; 32]` â†’ åˆ›å»º 32 å­—èŠ‚ï¼ˆ256 ä½ï¼‰æ•°ç»„
- `rand::thread_rng()` â†’ è·å–çº¿ç¨‹æœ¬åœ°éšæœºæ•°ç”Ÿæˆå™¨
- `.fill(&mut key_bytes)` â†’ ç”¨éšæœºå­—èŠ‚å¡«å……æ•°ç»„

**ä¸ºä»€ä¹ˆæ˜¯ 32 å­—èŠ‚**ï¼Ÿ
- âœ… AES-256 è¦æ±‚ 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰å¯†é’¥
- âœ… æ›´å®‰å…¨ï¼ˆ2^256 ç§å¯èƒ½æ€§ï¼‰

---

#### æ­¥éª¤ 4ï¼šBase64 ç¼–ç 

```rust
let new_key = general_purpose::STANDARD.encode(key_bytes);
```

**ä¸ºä»€ä¹ˆéœ€è¦ Base64 ç¼–ç **ï¼Ÿ
- âœ… å¯†é’¥æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼ˆä¸å¯æ‰“å°å­—ç¬¦ï¼‰
- âœ… ç³»ç»Ÿé’¥åŒ™ä¸²å­˜å‚¨å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯äºŒè¿›åˆ¶ï¼‰
- âœ… Base64 â†’ äºŒè¿›åˆ¶è½¬æ–‡æœ¬ï¼ˆå¯å®‰å…¨å­˜å‚¨ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
// åŸå§‹å¯†é’¥ï¼ˆ32 å­—èŠ‚äºŒè¿›åˆ¶ï¼‰
[0xAB, 0xCD, 0xEF, ..., 0x12]

// Base64 ç¼–ç åï¼ˆ44 å­—ç¬¦æ–‡æœ¬ï¼‰
"q83v...Eg=="
```

---

#### æ­¥éª¤ 5ï¼šå­˜å‚¨åˆ°é’¥åŒ™ä¸²

```rust
entry.set_password(&new_key).map_err(|e| {
    format!("æ— æ³•ä¿å­˜å¯†é’¥åˆ°ç³»ç»Ÿé’¥åŒ™ä¸²: {}", e)
})?;
```

**å­˜å‚¨æµç¨‹**ï¼š
```
Windows:
  new_key â†’ DPAPI åŠ å¯† â†’ Credential Manager

macOS:
  new_key â†’ Secure Enclave åŠ å¯† â†’ Keychain

Linux:
  new_key â†’ ç”¨æˆ·å¯†ç åŠ å¯† â†’ GNOME Keyring
```

---

## 4. å‰ç«¯è°ƒç”¨æµç¨‹

### 4.1 å‰ç«¯ä»£ç 

**æ–‡ä»¶ä½ç½®**ï¼š`src/crypto.ts (Line 18-27)`

```typescript
import { invoke } from '@tauri-apps/api/tauri';

export class SecureStorage {
  private key: CryptoKey | null = null;

  async init(): Promise<void> {
    // 1. ä» Rust åç«¯è·å–å¯†é’¥
    const keyBase64 = await invoke<string>('get_or_create_secure_key');

    // 2. Base64 è§£ç 
    const keyData = base64ToBytes(keyBase64);

    // 3. å¯¼å…¥ä¸º Web Crypto API å¯†é’¥
    this.key = await window.crypto.subtle.importKey(
      'raw',
      keyData,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  }
}
```

---

### 4.2 å®Œæ•´æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant Rust
    participant ç³»ç»Ÿé’¥åŒ™ä¸²
    participant æ–‡ä»¶ç³»ç»Ÿ

    å‰ç«¯->>Rust: invoke('get_or_create_secure_key')
    Rust->>ç³»ç»Ÿé’¥åŒ™ä¸²: Entry::new()
    ç³»ç»Ÿé’¥åŒ™ä¸²-->>Rust: Entry å¯¹è±¡
    Rust->>ç³»ç»Ÿé’¥åŒ™ä¸²: get_password()
    alt å¯†é’¥å­˜åœ¨
        ç³»ç»Ÿé’¥åŒ™ä¸²-->>Rust: Ok(key_base64)
        Rust-->>å‰ç«¯: key_base64
    else å¯†é’¥ä¸å­˜åœ¨
        Rust->>Rust: ç”Ÿæˆ 32 å­—èŠ‚éšæœºå¯†é’¥
        Rust->>Rust: Base64 ç¼–ç 
        Rust->>ç³»ç»Ÿé’¥åŒ™ä¸²: set_password(key_base64)
        ç³»ç»Ÿé’¥åŒ™ä¸²-->>Rust: Ok(())
        Rust-->>å‰ç«¯: key_base64
    end
    å‰ç«¯->>å‰ç«¯: Base64 è§£ç 
    å‰ç«¯->>å‰ç«¯: å¯¼å…¥ä¸º Web Crypto å¯†é’¥
    å‰ç«¯->>å‰ç«¯: åŠ å¯†é…ç½®æ•°æ®
    å‰ç«¯->>æ–‡ä»¶ç³»ç»Ÿ: ä¿å­˜åŠ å¯†åçš„é…ç½®
```

---

## 5. å®‰å…¨æ€§åˆ†æ

### 5.1 æ”»å‡»åœºæ™¯åˆ†æ

#### åœºæ™¯ 1ï¼šæ”»å‡»è€…è·å–é…ç½®æ–‡ä»¶

**é…ç½®æ–‡ä»¶å†…å®¹**ï¼ˆåŠ å¯†åï¼‰ï¼š
```json
{
  "encrypted": "AQ5pv3...base64ç¼–ç çš„å¯†æ–‡..."
}
```

**æ”»å‡»è€…èƒ½åšä»€ä¹ˆ**ï¼Ÿ
- âŒ æ— æ³•è§£å¯†ï¼ˆæ²¡æœ‰å¯†é’¥ï¼‰
- âŒ æ— æ³•ä»å¯†æ–‡æ¨å¯¼å¯†é’¥ï¼ˆAES-GCM å®‰å…¨æ€§ï¼‰
- âœ… æ•°æ®å®‰å…¨

---

#### åœºæ™¯ 2ï¼šæ”»å‡»è€…è·å–æºä»£ç 

**æºä»£ç å†…å®¹**ï¼š
```rust
const SERVICE_NAME: &str = "com.weibodr.uploader.secure";
const KEY_NAME: &str = "config_encryption_key";
```

**æ”»å‡»è€…èƒ½åšä»€ä¹ˆ**ï¼Ÿ
- âŒ åªæœ‰æœåŠ¡åå’Œå¯†é’¥åï¼ˆä¸æ˜¯å®é™…å¯†é’¥ï¼‰
- âŒ æ— æ³•ä»ç³»ç»Ÿé’¥åŒ™ä¸²è¯»å–å¯†é’¥ï¼ˆéœ€è¦ç”¨æˆ·è®¤è¯ï¼‰
- âœ… æ•°æ®å®‰å…¨

---

#### åœºæ™¯ 3ï¼šæ”»å‡»è€…è·å–å†…å­˜è½¬å‚¨

**å†…å­˜å†…å®¹**ï¼š
```
å¯†é’¥çš„ Base64 ç¼–ç : "q83v...Eg=="
```

**æ”»å‡»è€…èƒ½åšä»€ä¹ˆ**ï¼Ÿ
- âœ… å¯ä»¥è§£å¯†é…ç½®æ–‡ä»¶
- âŒ ä½†éœ€è¦ç‰©ç†è®¿é—®æ­£åœ¨è¿è¡Œçš„åº”ç”¨

**ç¼“è§£æªæ–½**ï¼š
- âœ… åº”ç”¨å…³é—­æ—¶å¯†é’¥ä»å†…å­˜æ¸…é™¤
- âœ… ä½¿ç”¨æ“ä½œç³»ç»Ÿå†…å­˜ä¿æŠ¤ï¼ˆä¸å¯è¢«å…¶ä»–è¿›ç¨‹è¯»å–ï¼‰

---

### 5.2 å®‰å…¨æ€§æ€»ç»“

| æ”»å‡»åœºæ™¯ | æ˜¯å¦å®‰å…¨ | åŸå›  |
|---------|---------|------|
| é…ç½®æ–‡ä»¶æ³„éœ² | âœ… å®‰å…¨ | å¯†æ–‡æ— æ³•è§£å¯† |
| æºä»£ç æ³„éœ² | âœ… å®‰å…¨ | æ— å®é™…å¯†é’¥ |
| ç³»ç»Ÿé’¥åŒ™ä¸²æ³„éœ² | âœ… å®‰å…¨ | éœ€è¦ç”¨æˆ·è®¤è¯ |
| å†…å­˜è½¬å‚¨ | âš ï¸ è¾ƒå®‰å…¨ | éœ€è¦ç‰©ç†è®¿é—® |
| è·¨ç”¨æˆ·è®¿é—® | âœ… å®‰å…¨ | é’¥åŒ™ä¸²éš”ç¦» |

---

## 6. æœ€ä½³å®è·µ

### 6.1 å¯†é’¥é•¿åº¦

```rust
// âœ… æ¨èï¼š256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰
let mut key_bytes = [0u8; 32];

// âš ï¸ å¯æ¥å—ï¼š128 ä½ï¼ˆ16 å­—èŠ‚ï¼‰
let mut key_bytes = [0u8; 16];

// âŒ ä¸æ¨èï¼š64 ä½ï¼ˆ8 å­—èŠ‚ï¼‰
let mut key_bytes = [0u8; 8];  // å¤ªçŸ­ï¼Œä¸å®‰å…¨
```

**å®‰å…¨æ€§å¯¹æ¯”**ï¼š
| å¯†é’¥é•¿åº¦ | å¯èƒ½æ€§æ•°é‡ | æš´åŠ›ç ´è§£æ—¶é—´ï¼ˆå‡è®¾æ¯ç§’å°è¯• 10^12 æ¬¡ï¼‰ |
|---------|-----------|--------------------------------|
| 64 ä½ | 2^64 | çº¦ 584 å¹´ |
| 128 ä½ | 2^128 | çº¦ 10^22 å¹´ |
| 256 ä½ | 2^256 | çº¦ 10^61 å¹´ âœ… |

---

### 6.2 éšæœºæ•°ç”Ÿæˆ

```rust
// âœ… æ¨èï¼šä½¿ç”¨æ“ä½œç³»ç»Ÿéšæœºæ•°ç”Ÿæˆå™¨
use rand::Rng;
let mut key_bytes = [0u8; 32];
rand::thread_rng().fill(&mut key_bytes);

// âŒ ä¸æ¨èï¼šä¼ªéšæœºæ•°ç”Ÿæˆå™¨
use rand::SeedableRng;
let mut rng = rand::rngs::StdRng::seed_from_u64(12345);  // å¯é¢„æµ‹ï¼
```

---

### 6.3 é”™è¯¯å¤„ç†

```rust
// âœ… æ¨èï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
entry.set_password(&new_key).map_err(|e| {
    format!("æ— æ³•ä¿å­˜å¯†é’¥åˆ°ç³»ç»Ÿé’¥åŒ™ä¸²: {}", e)
})?;

// âŒ ä¸æ¨èï¼šæ³›æ³›çš„é”™è¯¯ä¿¡æ¯
entry.set_password(&new_key).map_err(|_| {
    "Error".to_string()
})?;
```

---

## å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šæŸ¥çœ‹å­˜å‚¨çš„å¯†é’¥

**Windows**ï¼š
1. æ‰“å¼€"æ§åˆ¶é¢æ¿" â†’ "ç”¨æˆ·è´¦æˆ·" â†’ "å‡­æ®ç®¡ç†å™¨"
2. æ‰¾åˆ°"Windows å‡­æ®"
3. æŸ¥æ‰¾"com.weibodr.uploader.secure"
4. ç‚¹å‡»"æ˜¾ç¤º"æŸ¥çœ‹å¯†é’¥

**macOS**ï¼š
1. æ‰“å¼€"é’¥åŒ™ä¸²è®¿é—®"åº”ç”¨
2. æœç´¢"config_encryption_key"
3. åŒå‡»æŸ¥çœ‹è¯¦æƒ…
4. ç‚¹å‡»"æ˜¾ç¤ºå¯†ç "ï¼ˆéœ€è¦è¾“å…¥ç³»ç»Ÿå¯†ç ï¼‰

---

### ç»ƒä¹  2ï¼šåˆ é™¤å¯†é’¥å¹¶é‡æ–°ç”Ÿæˆ

**æ­¥éª¤**ï¼š
1. åˆ é™¤ç³»ç»Ÿé’¥åŒ™ä¸²ä¸­çš„å¯†é’¥
2. é‡å¯åº”ç”¨
3. è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š`[å¯†é’¥ç®¡ç†] ç”Ÿæˆæ–°çš„åŠ å¯†å¯†é’¥`
4. ç¡®è®¤æ–°å¯†é’¥å·²ä¿å­˜

---

### ç»ƒä¹  3ï¼šæ·»åŠ å¯†é’¥è½®æ¢åŠŸèƒ½

**ä»»åŠ¡**ï¼šå®ç°ä¸€ä¸ªå‘½ä»¤ï¼Œå®šæœŸè½®æ¢åŠ å¯†å¯†é’¥ï¼ˆæå‡å®‰å…¨æ€§ï¼‰ã€‚

**æç¤º**ï¼š
```rust
#[tauri::command]
fn rotate_encryption_key() -> Result<String, String> {
    let entry = Entry::new(SERVICE_NAME, KEY_NAME)?;

    // 1. ç”Ÿæˆæ–°å¯†é’¥
    let mut new_key_bytes = [0u8; 32];
    rand::thread_rng().fill(&mut new_key_bytes);
    let new_key = general_purpose::STANDARD.encode(new_key_bytes);

    // 2. ä¿å­˜åˆ°é’¥åŒ™ä¸²ï¼ˆè¦†ç›–æ—§å¯†é’¥ï¼‰
    entry.set_password(&new_key)
        .map_err(|e| format!("æ— æ³•ä¿å­˜æ–°å¯†é’¥: {}", e))?;

    eprintln!("[å¯†é’¥ç®¡ç†] âœ“ å¯†é’¥å·²è½®æ¢");
    Ok(new_key)
}
```

**æ³¨æ„**ï¼š
- âš ï¸ è½®æ¢å¯†é’¥åï¼Œæ—§çš„åŠ å¯†æ•°æ®éœ€è¦é‡æ–°åŠ å¯†
- âš ï¸ éœ€è¦å…ˆè§£å¯†æ—§æ•°æ® â†’ ç”¨æ–°å¯†é’¥åŠ å¯† â†’ ä¿å­˜

---

## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†å®‰å…¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼š

### å…³é”®çŸ¥è¯†ç‚¹
1. âœ… **ç³»ç»Ÿé’¥åŒ™ä¸²**ï¼šæ“ä½œç³»ç»Ÿçº§åŠ å¯†å­˜å‚¨
2. âœ… **è·¨å¹³å°æ”¯æŒ**ï¼šWindows Credential Managerã€macOS Keychainã€Linux Secret Service
3. âœ… **å¯†é’¥ç”Ÿæˆ**ï¼š256 ä½éšæœºå¯†é’¥ï¼ˆ`rand::thread_rng()`ï¼‰
4. âœ… **Base64 ç¼–ç **ï¼šäºŒè¿›åˆ¶å¯†é’¥ â†’ æ–‡æœ¬ï¼ˆä¾¿äºå­˜å‚¨ï¼‰
5. âœ… **å®‰å…¨æ€§**ï¼šåªæœ‰å½“å‰ç”¨æˆ·å¯è®¿é—®ï¼Œéœ€è¦æ“ä½œç³»ç»Ÿè®¤è¯

### å®‰å…¨ä¼˜åŠ¿
| å­˜å‚¨æ–¹å¼ | å®‰å…¨æ€§ | ç¼ºç‚¹ |
|---------|-------|------|
| ç¡¬ç¼–ç  | âŒ æä½ | æºä»£ç æ³„éœ² = å¯†é’¥æ³„éœ² |
| é…ç½®æ–‡ä»¶ | âŒ ä½ | å¯è¢«å…¶ä»–ç¨‹åºè¯»å– |
| ç³»ç»Ÿé’¥åŒ™ä¸² | âœ… é«˜ | æ“ä½œç³»ç»Ÿçº§ä¿æŠ¤ |

### å®ç°æµç¨‹
```
é¦–æ¬¡è¿è¡Œ: ç”Ÿæˆå¯†é’¥ â†’ Base64 ç¼–ç  â†’ å­˜å…¥é’¥åŒ™ä¸²
åç»­è¿è¡Œ: ä»é’¥åŒ™ä¸²è¯»å– â†’ Base64 è§£ç  â†’ ä½¿ç”¨
```

### ä¸‹ä¸€æ­¥

æ­å–œï¼ä½ å·²ç»å®Œæˆäº†ç¬¬4ç« çš„å­¦ä¹ ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹  **å‰åç«¯é€šä¿¡æœºåˆ¶**ï¼Œæ·±å…¥ç†è§£ Tauri IPC ç³»ç»Ÿã€‚

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼šç¬¬5ç«  å‰åç«¯é€šä¿¡](../../05-communication/01-tauri-ipc.md)
